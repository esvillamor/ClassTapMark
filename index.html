<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="description" content="ClassTapMark helps you manage classes, add students, and record daily attendance with quick status buttons.">
<meta name="theme-color" content="#667eea">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="mobile-web-app-capable" content="yes">
<meta name="msapplication-TileImage" content="icon192x192.png">
<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/png" sizes="32x32" href="image/favicon-32.png">
<link rel="apple-touch-icon" sizes="192x192" href="icon192x192.png">
<title>ClassTapMark</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
/* ====== Themed Styles (merged) ====== */
*{box-sizing:border-box}
:root{
  --bg1:#667eea; --bg2:#764ba2; --panel:#ffffff; --muted:#e8ecf4; --text:#222;
  --shadow:0 8px 32px rgba(0,0,0,.10);
  --radius:16px;
}
html,body{height:100%}
body{margin:0; padding:1rem; font:16px/1.45 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2)); color:var(--text);}
.container{max-width:1200px;margin:0 auto}
h1{color:#fff;text-align:center;margin:0 0 1.25rem}
.section{background:var(--panel);border-radius:var(--radius);padding:1.25rem;margin:1rem 0;box-shadow:var(--shadow)}
label,input,select,button{font-family:inherit}

/* Inputs */
input,select{padding:.8rem 1rem;border:2px solid #e1e5e9;border-radius:12px;background:#fafbff;transition:.2s}
input:focus,select:focus{outline:none;border-color:var(--bg1);box-shadow:0 0 0 3px rgba(102,126,234,.12)}

/* Buttons */
button{padding:.8rem 1.1rem;border:none;border-radius:12px;font-weight:500;cursor:pointer;transition:.2s}
button.primary{background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#fff}
button.edit{background: linear-gradient(135deg, #667eea, #764ba2); color: white;}
button.danger{background:linear-gradient(135deg,#ff6b6b,#ee5a52);color:#fff}
button:hover{transform:translateY(-1px);box-shadow:0 10px 22px rgba(0,0,0,.18)}
button:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}

/* Tables */
table{width:100%;border-collapse:collapse;margin:1rem 0;border-radius:12px;overflow:hidden;background:#fff;box-shadow:0 6px 18px rgba(0,0,0,.08)}
th,td{padding:.75rem .65rem;text-align:left;border-bottom:1px solid var(--muted);font-size:.95rem}
th{background:linear-gradient(135deg,#f0f4ff,#e8f0ff);font-weight:700}

/* Nav row */
.nav-row{display:flex;gap:.75rem;align-items:center;justify-content:center;background:rgba(255,255,255,.95);border-radius:12px;padding:.5rem 1rem;margin:1rem 0;box-shadow:0 6px 18px rgba(0,0,0,.12)}
.nav-btn{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#fff;font-size:1rem;display:flex;align-items:center;justify-content:center}
.nav-btn:hover{transform:scale(1.06)}

/* Status buttons */
.status-row{display:flex;gap:.5rem;justify-content:center;flex-wrap:wrap;margin:1rem 0}
.status-btn{border:2px solid #dee2e6;background:#f8f9fa;color:#333;min-width:82px}
.status-btn.present{background:#28a745;color:#fff;border-color:#20c997}
.status-btn.absent{background:#dc3545;color:#fff;border-color:#c82333}
.status-btn.tardy{background:#e0a800;color:#212529;border-color:#d97706}
.status-btn.cutting{background:#fd7e14;color:#fff;border-color:#f06b00}
.status-btn.excuse{background:linear-gradient(135deg,#20c997,#17a2b8);color:#fff;border-color:#138496}
.status-btn.pending{background:#ff9500;color:#fff;border-color:#e68900}

/* Current student highlight */
.currentStudent{background:linear-gradient(135deg,#ffecd2,#fcb69f);padding:1rem;border-radius:12px;text-align:center}

/* Debug */
.debug{background:linear-gradient(135deg,#fff3cd,#ffeaa7);padding:.8rem;border-radius:12px;font:13px/1.35 ui-monospace,Consolas,monospace;max-height:160px;overflow:auto}

/* Export modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none}
.modal .modal-content{background:#fff;margin:8% auto;padding:1.25rem;border-radius:16px;width:92%;max-width:560px;max-height:80vh;overflow:auto;box-shadow:var(--shadow)}
.date-container{border:1px solid #e1e5e9;border-radius:8px;padding:.6rem;background:#fafbff;max-height:160px;overflow:auto;margin:.35rem 0}
.current-date-center{display:block;padding:.7rem;border-radius:10px;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#fff;text-align:center}

.status-row {display: flex;flex-wrap: wrap;gap: 8px;width: 100%;padding: 8px;box-sizing: border-box;}

.status-btn {flex: 1 1 calc(16.666% - 8px); /* 6 buttons = ~16.67% each */min-width: 80px;padding: 12px 8px;border: 1px solid #ccc;border-radius: 6px;background: #f8f9fa;cursor: pointer;font-size: 14px;white-space: nowrap;transition: all 0.2s ease;}

/* Tablet: 3 buttons per row */
@media (max-width: 768px) {.status-btn {flex: 1 1 calc(33.333% - 6px); /* 3 buttons = ~33.33% each */}}

#studentTable {width: 100%;overflow-x: auto; /* Horizontal scroll only if needed */padding: 0 8px;box-sizing: border-box;-webkit-overflow-scrolling: touch; /* Smooth iOS scrolling */}

#studentTable, #attendanceTable {width: 100%;border-collapse: collapse;margin: 1rem 0;border-radius: 12px;overflow: hidden;font-size: 0.8rem; /* Reduced from original ~0.9rem */background: white;box-shadow: 0 4px 16px rgba(0,0,0,0.08);}

#studentTable th, #studentTable td, 
#attendanceTable th, #attendanceTable td {padding: 0.625rem 0.5rem;text-align: left;border-bottom: 1px solid #e8ecf4;font-size: 0.75rem; /* Smaller content font */}

#studentTable th, #attendanceTable th {background: linear-gradient(135deg, #f0f4ff, #e8f0ff) !important;font-weight: 600;}

/* Tables */
#studentTable, #attendanceTable { font-size: 0.75rem; }
#studentTable th, #studentTable td, #attendanceTable th, #attendanceTable td {padding: 0.5rem 0.375rem;font-size: 0.7rem;}

@media (max-width: 500px) {/* Ultra-compact */#studentTable, #attendanceTable { font-size: 0.7rem; }
#studentTable th, #studentTable td, #attendanceTable th, #attendanceTable td {
padding: 0.4rem 0.25rem;font-size: 0.65rem;}
</style>

<style id="patch-help-fab-css">
  /* Floating Action Buttons (FAB) ‚Äî consistent with your gradient & shadow theme */
  .fab {
    position: fixed;
    top: 14px;
    width: 46px;
    height: 46px;
    border: none;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--bg1), var(--bg2));
    color: #fff;
    font-weight: 800;
    font-size: 18px;
    cursor: pointer;
    box-shadow: 0 10px 22px rgba(0,0,0,.18);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    z-index: 1200;
    transition: transform .15s ease, box-shadow .15s ease, opacity .2s ease;
  }
  .fab:hover { transform: translateY(-1px) scale(1.04); }
  .fab:active { transform: scale(0.97); }
  .fab:focus { outline: none; box-shadow: 0 0 0 4px rgba(102,126,234,.20); }
  .fab[disabled] { opacity: .55; cursor: not-allowed; transform: none; }

  .fab-refresh { left: 14px; }
  .fab-help { right: 14px; }

  /* Help modal (reuses your .modal base) */
  #helpModal { position: fixed; inset: 0; background: rgba(0,0,0,.5); display: none; z-index: 1100; }
  #helpModal .modal-content {
    background: #fff;
    margin: 6% auto;
    padding: 1.25rem 1.25rem 1rem;
    border-radius: 14px;
    width: 94%;
    max-width: 820px;
    max-height: 84vh;
    overflow: auto;
    box-shadow: var(--shadow);
  }
  #helpModal h2, #helpModal h3 { margin: .2rem 0 .5rem; }
  #helpModal .meta { color:#667; font-size:.9rem; margin-bottom: .75rem; }
  #helpModal .close-row { display:flex; justify-content:space-between; align-items:center; gap:.75rem; margin-bottom:.5rem; }
  #helpModal .close-row .title {
    display:flex; align-items:center; gap:.6rem;
    background: linear-gradient(135deg, var(--bg1), var(--bg2));
    -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    font-weight: 800;
  }
  #helpModal .content p, 
  #helpModal .content li { line-height: 1.5; }
  #helpModal .eula {
    border-top: 1px solid #e8ecf4; margin-top: 1rem; padding-top: 1rem;
    background: #fafbff; border-radius: 10px; padding: 1rem;
  }
  #helpModal .kbd { 
    background:#eef2ff; border:1px solid #dfe6ff; border-radius:6px; padding:0 .35rem; 
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; 
    font-size:.85em; 
  }

  /* Small screens: space top buttons from iOS/Android UI chrome */
  @media (max-width: 480px) {
    .fab { top: 10px; width: 44px; height: 44px; }
    .fab-refresh { left: 10px; }
    .fab-help { right: 10px; }
  }
</style>
</head>
<body>
  <div class="container">
    <h1>ClassTapMark</h1>

    <!-- Manage Classes -->
    <div class="section">
      <h3>üìö Manage Classes</h3>
      <div style="display:flex;gap:.6rem;flex-wrap:wrap">
        <input id="className" placeholder="Enter Class Name eg. Gr7-A" style="flex:2;min-width:220px">
        <button class="primary" onclick="addClass()">Create Class</button>
      </div>
      <div style="margin:.6rem 0">
        <select id="classDropdown" style="width:100%"><option value="">Select Class</option></select>
      </div>
		<div style="display:flex;gap:.6rem;flex-wrap:wrap;width:100%;">
		  <button class="primary" id="btnSelectClass" style="flex:1;" onclick="selectClassFromDropdownWithCreate()">Load Class</button>
		  <button class="edit" id="btnEditClass" style="flex:1;" disabled onclick="editClass()">Edit Class</button>
		  <button class="danger" id="btnDeleteClass" style="flex:1;" disabled onclick="deleteSelectedClass()">Delete Class</button>
		</div>
    </div>

    <div id="classContent" class="section disabled">
      <h3>üë• Manage Students</h3>
      <span id="classHeader" style="font-weight:600;background:linear-gradient(135deg,var(--bg1),var(--bg2));-webkit-background-clip:text;-webkit-text-fill-color:transparent">[Class Name]</span>
      <div class="student-form">
        <div id="studentClassGroup" style="display:none;gap:.6rem;align-items:end;margin:.6rem 0">
          <label for="studentClassSelect">Move to Class:</label>
          <select id="studentClassSelect"></select>
        </div>
        <div style="display:flex;justify-content:center;gap:1rem;align-items:end;flex-wrap:wrap;margin:.6rem 0">
          <input id="studentName" placeholder="Last Name, First Name Middle Name" style="flex:2;min-width:240px;max-width:600px">
		</div>
		<div style="display: flex; justify-content: center; flex-direction: column; align-items: center; gap: 1rem; padding: 1rem;">
		<div style="display:flex; gap:1rem; align-items:end; flex-wrap:wrap; max-width: 100%;">
          <label style="display:flex;align-items:center;gap:.35rem"><input type="radio" name="studentSex" value="Male" id="sexMale" checked> Male</label>
          <label style="display:flex;align-items:center;gap:.35rem"><input type="radio" name="studentSex" value="Female" id="sexFemale"> Female</label>
		</div>
		<div style="display: flex; gap: 0.6rem; flex-wrap: wrap; justify-content: center; width: 100%; align-items: center;">
		  <button class="primary" style="flex: 1; min-width: 120px;" onclick="importCSV()" title="Select a class from the dropdown to enable importing">Import Student</button>
		  <button class="primary" style="flex: 1; min-width: 120px;" onclick="addStudent()">Add Student</button>
		</div>
		<div style="display: flex; gap: 0.6rem; flex-wrap: wrap; justify-content: center; width: 100%; align-items: center;">
		  <button class="primary" style="flex: 1; min-width: 120px;" disabled onclick="exportCSV()">Export Student</button>
		</div>
		</div>
        <table id="studentTable"><thead><tr>
		<th style="width:3%">#</th>
		<th style="width:32%">Name</th>
		<th style="width:10%">Sex</th>
		<th style="width:20%">Added</th>
		<th style="width:35%">Actions</th>
		</tr></thead><tbody></tbody></table>
      </div>
    </div>

    <!-- Mark Attendance -->
    <div class="section">
      <h3>üìÖ Mark Attendance</h3>
      <span id="attendanceClassHeader" style="font-weight:600;background:linear-gradient(135deg,var(--bg1),var(--bg2));-webkit-background-clip:text;-webkit-text-fill-color:transparent">[Class Name]</span>

      <!-- Daily status summary by sex -->
      <div id="studentTable">
        <table class="status-table">
          <thead>
            <tr><th>Sex</th><th>Present</th><th>Absent</th><th>Tardy</th><th>Cutting</th><th>Excuse</th><th>Pending</th></tr>
          </thead>
          <tbody id="statusTableBody"></tbody>
        </table>
      </div>

      <div id="currentStudent" class="currentStudent">Select a Class to begin</div>
      <div class="status-row">
        <button class="status-btn" onclick="markAttendance('present')">Present</button>
        <button class="status-btn" onclick="markAttendance('absent')">Absent</button>
        <button class="status-btn" onclick="markAttendance('tardy')">Tardy</button>
        <button class="status-btn" onclick="markAttendance('cutting')">Cutting</button>
        <button class="status-btn" onclick="markAttendance('excuse')">Excuse</button>
        <button class="status-btn" onclick="markAttendance('pending')">Pending</button>
      </div>

      <div class="nav-row">
        <input type="date" id="datePicker" style="min-width:160px">
        <button class="nav-btn" onclick="navigateStudent('first')" title="First">‚è™</button>
        <button class="nav-btn" onclick="navigateStudent('prev')" title="Previous">‚óÄ</button>
        <button class="nav-btn" onclick="navigateStudent('next')" title="Next">‚ñ∂</button>
        <button class="nav-btn" onclick="navigateStudent('last')" title="Last">‚è©</button>
      </div>

      <table id="attendanceTable"><thead><tr>
	  <th>#</th>
	  <th>Student</th>
	  <th style="width:10%">Sex</th>
	  <th>Status</th>
	  <th style="width:20%">Date</th></tr></thead><tbody></tbody></table>
    </div>

    <div class="section">
<div style="display: flex; gap: 0.6rem; flex-wrap: wrap; justify-content: space-between; width: 100%; margin: 0; padding: 0;">
  <button class="primary" onclick="openExportModal()" style="flex: 1; min-width: 150px;">üì• Export CSV</button>
  <button class="primary" onclick="clearDebug()" style="flex: 1; min-width: 150px;">üßπ Clear Tasks Log</button>
</div>
      <div id="debugInfo" class="debug">Task log will appear here</div>

      <!-- Export modal -->
	  <div id="exportModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
		<div class="modal-content" style="background: white; margin: 10% auto; padding: 2rem; border-radius: 12px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
		  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3>Select Dates for Export</h3>
            <button id="closeModal" class="danger" style="padding:.25rem .6rem">‚úï</button>
          </div>
          <div id="dateSelection"></div>
          <div style="display:flex;gap:.6rem;justify-content:flex-end;margin-top:.6rem">
            <button id="cancelExport" class="edit" onclick="closeExportModal()">Cancel</button>
            <button id="confirmExport" class="primary" onclick="confirmExport()">Export Selected</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
// ===== State =====
let currentClassId = null;
let currentStudents = [];
let currentAttendance = {};
let currentStudentIndex = 0;
let editingClassId = null;
let editingStudentIndex = -1;
let editingStudentId = null;
let selectedDates = [];

// ===== Utils =====
function normalizeName(name){
  if(!name) return '';
  return name.trim().toLowerCase().replace(/[^\w\s]/g,'').replace(/\s+/g,' ');
}
function generateId(){ return 'cls'+Date.now()+Math.random().toString(36).substr(2,9); }
function updateDebug(msg){ const d=document.getElementById('debugInfo'); d.innerHTML = '<div>'+new Date().toLocaleTimeString()+': '+msg+'</div>'+ d.innerHTML; d.scrollTop = 0; }
function setTodayDate(){ const dp=document.getElementById('datePicker'); const now=new Date(); dp.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`; }

// ===== Classes =====
function getAllClasses(){ try{ const raw=localStorage.getItem('attendanceclasses'); if(!raw) return []; const arr=JSON.parse(raw); const valid = Array.isArray(arr)?arr.filter(c=>c&&c.id&&c.name&&String(c.name).trim()):[]; if(valid.length!==arr.length) localStorage.setItem('attendanceclasses', JSON.stringify(valid)); return valid; }catch(e){ localStorage.removeItem('attendanceclasses'); return []; } }
function populateClassDropdown(){ const sel=document.getElementById('classDropdown'); const classes=getAllClasses(); sel.innerHTML='<option value="">Select Class</option>'; classes.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=`${c.name} (${getStudentCount(c.id)})`; sel.appendChild(o); }); updateButtons(); }
function updateButtons(){ const id=document.getElementById('classDropdown').value; document.getElementById('btnEditClass').disabled = !id; document.getElementById('btnDeleteClass').disabled = !id; const btn=document.querySelector('button[onclick="importCSV()"]'); if(btn) btn.disabled = !id; }
function getStudentCount(classId){ try{ const s=localStorage.getItem(`students-${classId}`); if(!s) return 0; const arr=JSON.parse(s); return Array.isArray(arr)?arr.length:0; }catch{ return 0; } }

function addClass(){ const name=document.getElementById('className').value.trim(); if(!name){ alert('Enter class name!'); return; } let id=editingClassId||generateId(); let classes=getAllClasses(); if(editingClassId){ const i=classes.findIndex(c=>c.id===editingClassId); if(i>-1) classes[i].name=name; } else { classes.push({id,name,created:new Date().toISOString()}); } localStorage.setItem('attendanceclasses', JSON.stringify(classes)); document.getElementById('className').value=''; editingClassId=null; populateClassDropdown(); updateButtons(); }
function editClass(){ const id=document.getElementById('classDropdown').value; if(!id){ alert('Select class to edit'); return; } const c=getAllClasses().find(x=>x.id===id); if(!c) return; editingClassId=id; document.getElementById('className').value=c.name; }
function deleteSelectedClass(){ const id=document.getElementById('classDropdown').value; if(!id) return; if(!confirm('Delete class and ALL related data?')) return; let classes=getAllClasses().filter(c=>c.id!==id); Object.keys(localStorage).forEach(k=>{ if(k.includes(id)) localStorage.removeItem(k); }); localStorage.setItem('attendanceclasses', JSON.stringify(classes)); if(currentClassId===id){ currentClassId=null; document.getElementById('classContent').classList.add('disabled'); document.querySelector('#studentTable tbody').innerHTML=''; document.querySelector('#attendanceTable tbody').innerHTML=''; (function(el){ if(el) el.innerHTML=''; })(document.getElementById('statusTableBody')); document.getElementById('currentStudent').textContent='Select a Class to begin...'; }
 populateClassDropdown(); updateButtons(); }

function selectClassFromDropdownWithCreate(){ let id=document.getElementById('classDropdown').value; if(!id){ const name=document.getElementById('className').value.trim(); if(!name){ alert('Enter class name first, then select or create!'); document.getElementById('className').focus(); return; } id=generateId(); const classes=getAllClasses(); classes.push({id,name,created:new Date().toISOString()}); localStorage.setItem('attendanceclasses', JSON.stringify(classes)); populateClassDropdown(); document.getElementById('classDropdown').value=id; }
 selectClass(id); updateButtons(); }
function selectClass(id){ if(!id) return; currentClassId=id; const cls=getAllClasses().find(c=>c.id===id); if(!cls){ currentClassId=null; document.getElementById('classContent').classList.add('disabled'); return; } document.getElementById('classHeader').textContent=cls.name; document.getElementById('attendanceClassHeader').textContent=cls.name; document.getElementById('classContent').classList.remove('disabled'); loadClassStudents(); currentStudentIndex=0; setTodayDate(); document.getElementById('datePicker').dispatchEvent(new Event('change',{bubbles:true})); updateCurrentStudent(); populateClassDropdown(); updateStatusSummary(); updateButtons(); }

// ===== Students =====
function sortStudentsBySex(students){ return students.sort((a,b)=>{ if(a.sex==='Male'&&b.sex!=='Male') return -1; if(b.sex==='Male'&&a.sex!=='Male') return 1; return a.name.localeCompare(b.name); }); }
function getSelectedSex(){ const el=document.querySelector('input[name="studentSex"]:checked'); return el?el.value:''; }
function hasDuplicateName(name,sex,exclude=-1){ return currentStudents.some((s,i)=> i!==exclude && s.name.toLowerCase()===name.toLowerCase() && s.sex===sex); }
function loadClassStudents(skip=false){ if(!currentClassId) return; let students=JSON.parse(localStorage.getItem('students-'+currentClassId)||'[]'); currentStudents=sortStudentsBySex(students); const tbody=document.querySelector('#studentTable tbody'); let html=''; const males=currentStudents.filter(s=>s.sex==='Male'); const females=currentStudents.filter(s=>s.sex==='Female'); males.forEach((s,i)=>{ const idx=currentStudents.findIndex(u=>u.id===s.id); html+=`<tr><td style="font-weight:600;color:#667eea;width:40px">${i+1}</td><td>${s.name}</td><td>${s.sex}</td><td>${new Date(s.added).toISOString().slice(0,10)}</td><td class="action-cell"><button class="edit" onclick=\"editStudent(${idx})\">‚úèÔ∏è</button> <button class="danger" onclick=\"deleteStudent(${idx})\">üóëÔ∏è</button></td></tr>`; }); let fi=1; females.forEach((s)=>{ const idx=currentStudents.findIndex(u=>u.id===s.id); html+=`<tr><td style=\"font-weight:600;color:#667eea;width:40px\">${fi}</td><td>${s.name}</td><td>${s.sex}</td><td>${new Date(s.added).toISOString().slice(0,10)}</td><td class=\"action-cell\"><button class=\"edit\" onclick=\"editStudent(${idx})\">‚úèÔ∏è</button> <button class=\"danger\" onclick=\"deleteStudent(${idx})\">üóëÔ∏è</button></td></tr>`; fi++; }); tbody.innerHTML=html; if(!skip) loadAttendance(); updateStatusSummary(); updateCurrentStudent(); }

function addStudent(){
  const nameEl = document.getElementById('studentName');
  const name = (nameEl?.value || '').trim();
  const sex = getSelectedSex();

  if(!name || !sex){
    alert('Name and sex required!');
    return;
  }

  // Prefer studentClassSelect ‚Üí currentClassId ‚Üí dropdown value
  const classSel = document.getElementById('studentClassSelect');
  const ddVal = (document.getElementById('classDropdown')?.value || null);
  const targetClassId = (classSel?.value || currentClassId || ddVal);
  if(!targetClassId){
    alert('Select class first!');
    return;
  }

  // Ensure currentStudents is an array
  if(!Array.isArray(currentStudents)) currentStudents = [];

  // Determine if we're still in a valid edit state
  const cur = (typeof editingStudentIndex === 'number' && editingStudentIndex > -1)
    ? currentStudents[editingStudentIndex]
    : null;

  const originalIdFromDataset = nameEl?.dataset?.originalId;
  let isEditing = !!cur;
  if(isEditing && originalIdFromDataset && cur.id !== originalIdFromDataset){
    isEditing = false; // dataset doesn't match current index -> treat as "add new"
  }
  if(!isEditing){
    editingStudentIndex = -1;
    editingStudentId = null;
  }

  // Duplicate name check (exclude current index only if valid edit)
  if(hasDuplicateName(name, sex, isEditing ? editingStudentIndex : -1)){
    alert(`Duplicate name "${name}" (${sex}) already exists!`);
    return;
  }

  // Preserve "added" only on valid edit; else use now
  const addedVal = isEditing ? (cur?.added || new Date().toISOString()) : new Date().toISOString();
  const studentData = { name, sex, added: addedVal };

  if(isEditing && targetClassId === currentClassId){
    // Editing within same class: update
    const finalId = originalIdFromDataset || cur.id;
    currentStudents[editingStudentIndex] = { id: finalId, ...studentData };
    localStorage.setItem(`students-${currentClassId}`, JSON.stringify(currentStudents));
  } else {
    // New student or moved to another class
    const studentId = isEditing
      ? (editingStudentId || cur?.id || generateId())
      : generateId();
    const student = { id: studentId, ...studentData };

    // If we were editing in current class, remove old record
    if(isEditing && currentClassId && editingStudentIndex > -1){
      currentStudents.splice(editingStudentIndex, 1);
      localStorage.setItem(`students-${currentClassId}`, JSON.stringify(currentStudents));
    }

    // Insert/update in target class
    let target = JSON.parse(localStorage.getItem(`students-${targetClassId}`) || '[]');
    const existingIndex = target.findIndex(s => s.id === studentId);
    if(existingIndex > -1) target[existingIndex] = student;
    else target.push(student);
    target = sortStudentsBySex(target);
    localStorage.setItem(`students-${targetClassId}`, JSON.stringify(target));
    populateClassDropdown();
  }

  // Refresh tables/status
  if(currentClassId) loadClassStudents();
  const date = document.getElementById('datePicker')?.value;
  if(date && currentClassId) loadAttendance();

  // --- Always clear form & edit state ---
  if(nameEl){ nameEl.value = ''; delete nameEl.dataset.originalId; }
  const sexMale = document.getElementById('sexMale'); if(sexMale) sexMale.checked = true;
  const group = document.getElementById('studentClassGroup'); if(group) group.style.display = 'none';
  editingStudentIndex = -1;
  editingStudentId = null;

  // If patch helpers exist, sync buttons
  if(typeof setStudentExportEnabled === 'function') setStudentExportEnabled(false);
  if(typeof setCancelEditEnabled === 'function') setCancelEditEnabled(false);
}

function editStudent(index){ const s=currentStudents[index]; editingStudentIndex=index; editingStudentId=s.id; const select=document.getElementById('studentClassSelect'); document.getElementById('studentName').dataset.originalId=s.id; document.getElementById('studentName').value=s.name; document.getElementById('sexMale').checked=s.sex==='Male'; document.getElementById('sexFemale').checked=s.sex==='Female'; const classes=getAllClasses(); select.innerHTML='<option value="">Stay in current class</option>'; classes.forEach(cls=>{ if(cls.id!==currentClassId){ const o=document.createElement('option'); o.value=cls.id; o.textContent=cls.name; select.appendChild(o); } }); document.getElementById('studentClassGroup').style.display='flex'; }



function deleteStudent(index){
  try{
    // Resolve active class (currentClassId ‚Üí dropdown)
    const activeId = currentClassId || (document.getElementById('classDropdown')?.value || null);
    if(!activeId){
      alert('Select a class first.');
      return;
    }

    // Ensure we have the current list
    if(!Array.isArray(currentStudents)) currentStudents = [];
    let resolvedIndex = (typeof index === 'number') ? index : -1;

    // If index invalid, attempt to resolve from clicked row (using window.event)
    if(resolvedIndex < 0 || resolvedIndex >= currentStudents.length){
      const ev = window.event;
      const btn = ev && ev.target ? ev.target.closest('button') : null;
      const row = btn ? btn.closest('tr') : null;
      if(row){
        const cells = row.querySelectorAll('td');
        const nameText = cells && cells[1] ? cells[1].textContent.trim() : '';
        const sexText  = cells && cells[2] ? cells[2].textContent.trim() : '';
        if(nameText && sexText){
          resolvedIndex = currentStudents.findIndex(s => s.name === nameText && s.sex === sexText);
        }
      }
    }

    // If still invalid, rebuild from storage and try dataset.originalId as hint
    if(resolvedIndex < 0 || resolvedIndex >= currentStudents.length){
      const fromStore = JSON.parse(localStorage.getItem(`students-${activeId}`) || '[]');
      currentStudents = fromStore.slice();
      const origId = (document.getElementById('studentName') || {}).dataset?.originalId;
      if(origId){
        resolvedIndex = currentStudents.findIndex(s => s.id === origId);
      }
    }

    if(resolvedIndex < 0 || resolvedIndex >= currentStudents.length){
      alert('Reload class > Selected Class from the dropdown > Edit Student and click Delete.');
      return;
    }

    const s = currentStudents[resolvedIndex];
    if(!confirm(`Delete this student and ALL their attendance?\n\n${s.name} (${s.sex})`)) return;

    const sid = s.id;

    // Remove from currentStudents + persist
    currentStudents.splice(resolvedIndex, 1);
    localStorage.setItem(`students-${activeId}`, JSON.stringify(currentStudents));

    // Remove attendance across all dates for this class and purge empty date keys
    const suffix = `-${activeId}`;
    for(const k of Object.keys(localStorage)){
      if(k.startsWith('attendance-') && k.endsWith(suffix)){
        try{
          const att = JSON.parse(localStorage.getItem(k) || '{}');
          if(att && Object.prototype.hasOwnProperty.call(att, sid)){
            delete att[sid];
            if(Object.keys(att).length === 0){
              localStorage.removeItem(k);
            } else {
              localStorage.setItem(k, JSON.stringify(att));
            }
          }
        }catch{}
      }
    }

    // üîî Auto "Cancel Edit" after successful delete
    if (typeof window.cancelEdit === 'function') {
      window.cancelEdit();                 // preferred: uses your centralized logic
    } else {
      const cancelBtn = document.getElementById('btnCancelEdit');
      if (cancelBtn) cancelBtn.click();    // fallback: simulate click if function not found
      // Last-resort local clear (shouldn't be needed if either path above exists)
      const nameEl = document.getElementById('studentName');
      if(nameEl){ nameEl.value = ''; delete nameEl.dataset.originalId; }
      const sexMale = document.getElementById('sexMale'); if(sexMale) sexMale.checked = true;
      const group = document.getElementById('studentClassGroup'); if(group) group.style.display = 'none';
      editingStudentIndex = -1;
      editingStudentId = null;
      if(typeof setStudentExportEnabled === 'function') setStudentExportEnabled(false);
      if(typeof setCancelEditEnabled === 'function') setCancelEditEnabled(false);
      if(typeof resetStudentExportBtnLabel === 'function') resetStudentExportBtnLabel();
    }

    // Refresh UI (table + counts + summary)
    loadClassStudents();
    populateClassDropdown();
    if(typeof updateDebug === 'function'){
      updateDebug(`Deleted ${s.name} and removed all their attendance.`);
    }
  }catch(err){
    alert('Delete failed: ' + err.message);
  }
}



// ===== Attendance =====
function loadAttendance(){ const date=document.getElementById('datePicker').value; if(!date||!currentClassId) return; const key=`attendance-${date}-${currentClassId}`; currentAttendance=JSON.parse(localStorage.getItem(key)||'{}'); updateAttendanceDisplay(); updateStatusSummary(); updateCurrentStudent(); }
function markAttendance(status){ const date=document.getElementById('datePicker').value; if(!date||!currentClassId) return; const student=currentStudents[currentStudentIndex]; if(!student?.id) return alert('No student selected!'); const key=`attendance-${date}-${currentClassId}`; const att=JSON.parse(localStorage.getItem(key)||'{}'); att[student.id]={ status, timestamp:new Date().toISOString() }; localStorage.setItem(key, JSON.stringify(att)); document.querySelectorAll('.status-btn').forEach(b=>b.classList.remove('present','absent','tardy','cutting','excuse','pending','active')); if(window.event) window.event.target.classList.add(status,'active'); loadAttendance(); }
function updateAttendanceDisplay(){ const date=document.getElementById('datePicker').value; if(!date||!currentClassId||!currentStudents){ document.querySelector('#attendanceTable tbody').innerHTML='<tr><td colspan="5">Select class and date</td></tr>'; return; } let html=''; const males=currentStudents.filter(s=>s.sex==='Male'); const females=currentStudents.filter(s=>s.sex==='Female'); const color=s=>({present:'#28a745',absent:'#dc3545',tardy:'#ffc107',cutting:'#fd7e14',excuse:'#17a2b8',pending:'#ff9500'})[s]||'#ff9500'; males.forEach((st,i)=>{ const rec=currentAttendance[st.id]; const stt=(rec?rec.status:'pending').toLowerCase(); html+=`<tr><td style=\"font-weight:600;color:#667eea;width:40px\">${i+1}</td><td>${st.name}</td><td>${st.sex}</td><td style=\"font-weight:600;color:${color(stt)}\">${stt.toUpperCase()}</td><td>${date}</td></tr>`; }); let fi=1; females.forEach(st=>{ const rec=currentAttendance[st.id]; const stt=(rec?rec.status:'pending').toLowerCase(); html+=`<tr><td style=\"font-weight:600;color:#667eea;width:40px\">${fi}</td><td>${st.name}</td><td>${st.sex}</td><td style=\"font-weight:600;color:${color(stt)}\">${stt.toUpperCase()}</td><td>${date}</td></tr>`; fi++; }); document.querySelector('#attendanceTable tbody').innerHTML=html; }
function updateStatusSummary(){ const statuses=['present','absent','tardy','cutting','excuse','pending']; const male={}, female={}, total={}; statuses.forEach(s=>{ male[s]=0; female[s]=0; total[s]=0; }); currentStudents.forEach(st=>{ const rec=currentAttendance[st.id]; const s=(rec?rec.status:'pending'); if(st.sex==='Male') male[s]++; else female[s]++; total[s]++; }); const males=currentStudents.filter(s=>s.sex==='Male').length||0; const females=currentStudents.filter(s=>s.sex==='Female').length||0; const t=currentStudents.length||0; const body=document.getElementById('statusTableBody'); if(body) body.innerHTML = `<tr><td>Male: ${males}</td>${statuses.map(s=>`<td>${male[s]}</td>`).join('')}</tr><tr><td>Female: ${females}</td>${statuses.map(s=>`<td>${female[s]}</td>`).join('')}</tr><tr style=\"font-weight:bold;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff\"><td>Total: ${t}</td>${statuses.map(s=>`<td>${total[s]}</td>`).join('')}</tr>`; }
function navigateStudent(dir){ document.querySelectorAll('.status-btn').forEach(btn=>btn.classList.remove('present','absent','tardy','cutting','excuse','pending','active')); const len=currentStudents.length; if(!len) return; if(dir==='first') currentStudentIndex=0; else if(dir==='prev' && currentStudentIndex>0) currentStudentIndex--; else if(dir==='next' && currentStudentIndex<len-1) currentStudentIndex++; else if(dir==='last') currentStudentIndex=len-1; updateCurrentStudent(); }
function updateCurrentStudent(){ if(!currentStudents || currentStudentIndex>=currentStudents.length){ document.getElementById('currentStudent').textContent='No students'; return; } const s=currentStudents[currentStudentIndex]; const rec=currentAttendance[s.id]; const status=(rec?rec.status:'PENDING').toLowerCase(); const color={present:'#28a745',absent:'#dc3545',tardy:'#e0a800',cutting:'#fd7e14',excuse:'#17a2b8',pending:'#ff9500'}[status]||'#ff9500'; document.getElementById('currentStudent').innerHTML='Student '+(currentStudentIndex+1)+' of '+currentStudents.length+'<br><strong>'+s.name+'</strong> ('+s.sex+')<br><span style="color:'+color+';font-weight:600;font-size:1.05rem">'+status.toUpperCase()+'</span>'; }

// ===== Export =====
function openExportModal(){ if(!currentClassId) return alert('Select a class first!'); selectedDates=[]; const ds=document.getElementById('dateSelection'); const today=new Date(); const todayStr=today.toISOString().split('T')[0]; let html=''; html+='<div class="date-container" id="futureDates">'; for(let i=364;i>=1;i--){ const d=new Date(today); d.setDate(today.getDate()+i); const s=d.toISOString().split('T')[0]; const l=d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'}); html+=`<label title=\"${s}\"><input type=\"checkbox\" value=\"${s}\" onchange=\"toggleDate('${s}')\" style=\"margin-right:.5rem\"> ${l}</label>`; } html+='</div>'; html+=`<label class=\"current-date-center\" title=\"${todayStr}\"><input type=\"checkbox\" value=\"${todayStr}\" onchange=\"toggleDate('${todayStr}')\" checked style=\"margin-right:.5rem\"> Present Date ${today.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'})}</label>`; html+='<div class="date-container" id="pastDates">'; for(let i=1;i<=365;i++){ const d=new Date(today); d.setDate(today.getDate()-i); const s=d.toISOString().split('T')[0]; const l=d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'}); html+=`<label title=\"${s}\"><input type=\"checkbox\" value=\"${s}\" onchange=\"toggleDate('${s}')\" style=\"margin-right:.5rem\"> ${l}</label>`; } html+='</div>'; ds.innerHTML=html; document.getElementById('exportModal').style.display='block'; }
function toggleDate(s){ const i=selectedDates.indexOf(s); if(i>-1) selectedDates.splice(i,1); else selectedDates.push(s); }
function closeExportModal(){ document.getElementById('exportModal').style.display='none'; }
function confirmExport(){ if(selectedDates.length===0) return alert('Select at least one date!'); closeExportModal(); const cls=getAllClasses().find(c=>c.id===currentClassId); const className=cls?cls.name:'unknown'; selectedDates.forEach(dateStr=>{ const key=`attendance-${dateStr}-${currentClassId}`; const data=JSON.parse(localStorage.getItem(key)||'{}'); const rows=['"Class","Student","Sex","Status","Date"']; currentStudents.forEach(st=>{ const rec=data[st.id]; const status=rec?rec.status:'PENDING'; const fields=[ className.replace(/\"/g,'\"\"'), st.name.replace(/\"/g,'\"\"'), st.sex.replace(/\"/g,'\"\"'), status.toUpperCase().replace(/\"/g,'\"\"'), dateStr ]; rows.push(fields.map(f=>`\"${f}\"`).join(',')); }); const csv=rows.join('\\n'); const filename=`${dateStr}_${className.replace(/[^a-zA-Z0-9_\-]/g,'_')}_attendance.csv`; downloadFile([csv], filename, 'text/csv'); }); }
function downloadFile(content, filename, mimeType){ try{ const txt=Array.isArray(content)?content.join('\\n'):content; const blob=new Blob([txt],{type:mimeType||'application/octet-stream'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); },100); }catch(e){ alert('Download failed: '+e.message); } }

// ===== Import (robust date parsing + strict per-date save) =====
(function(){
  function parseDateFromCell(raw){
    if(raw==null||raw==='') return null; const s=String(raw).trim();
    if(!isNaN(s)&&s!==''){ const serial=Number(s); if(serial>0&&isFinite(serial)){ const excelEpoch=Date.UTC(1899,11,30); return new Date(excelEpoch+serial*86400000).toISOString().slice(0,10);} }
    const m=s.match(/^(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})$/); if(m){ const yyyy=m[1],mm=m[2].padStart(2,'0'),dd=m[3].padStart(2,'0'); return `${yyyy}-${mm}-${dd}`; }
    const d=new Date(s); return isNaN(d.getTime())?null:d.toISOString().slice(0,10);
  }
  window.handleCSVFile=function(e){ const targetClassId=e.target.targetClassId; const file=e.target.files&&e.target.files[0]; if(!file) return; const reader=new FileReader(); reader.onload=(ev)=>{ try{
    const data=new Uint8Array(ev.target.result); const wb=XLSX.read(data,{type:'array',raw:true,cellDates:true}); const sheet=wb.Sheets[wb.SheetNames[0]]; const json=XLSX.utils.sheet_to_json(sheet,{header:1,raw:true}); if(!Array.isArray(json)||json.length<=1){ alert('No rows found.'); return;} json.shift();
    const statusPrefixes=['present-','absent-','tardy-','cutting-','excuse-','pending-'];
    const temp=[]; for(const row of json){ if(!row||row.length<2) continue; const [,rawName,sex,rawStatus='pending',rawDate]=row; const nameStr=String(rawName||'').trim(); const sexStr=String(sex||'').trim(); if(!nameStr||!['Male','Female'].includes(sexStr)) continue; let status=String(rawStatus||'').trim().toLowerCase(); for(const p of statusPrefixes){ if(status.startsWith(p)){ status=status.slice(p.length); break; } } status=status||'pending'; let dateStr=parseDateFromCell(rawDate); if(!dateStr && (rawDate==null || String(rawDate).trim()==='')){ dateStr=new Date().toISOString().slice(0,10);} else if(!dateStr){ updateDebug('Skipped row for "'+nameStr+'" ‚Äì invalid Date "'+rawDate+'"'); continue; } const key=`${normalizeName(nameStr)}-${sexStr.toLowerCase()}`; temp.push({ key, origName:nameStr, sex:sexStr, status, date:dateStr }); }
    let existing=JSON.parse(localStorage.getItem(`students-${targetClassId}`)||'[]'); const map=new Map(existing.map(s=>[`${normalizeName(s.name)}-${s.sex.toLowerCase()}`, s.id])); let students = existing.slice();
    const seen=new Set(existing.map(s=>`${normalizeName(s.name)}-${s.sex.toLowerCase()}`)); for(const it of temp){ if(seen.has(it.key)) continue; seen.add(it.key); const id=map.get(it.key)||generateId(); students.push({ id, name:it.origName, sex:it.sex, added:new Date().toISOString() }); }
    students.sort((a,b)=> (a.sex==='Male'&&b.sex!=='Male')?-1:(b.sex==='Male'&&a.sex!=='Male')?1:a.name.localeCompare(b.name)); localStorage.setItem(`students-${targetClassId}`, JSON.stringify(students));
    for(const it of temp){ const sid = map.get(it.key) || (students.find(s=>`${normalizeName(s.name)}-${s.sex.toLowerCase()}`===it.key)||{}).id; if(!sid) continue; const k=`attendance-${it.date}-${targetClassId}`; const att=JSON.parse(localStorage.getItem(k)||'{}'); att[sid]={ status:it.status, timestamp:new Date().toISOString() }; localStorage.setItem(k, JSON.stringify(att)); }
    alert('Success! Import complete.'); if(currentClassId!==targetClassId){ currentClassId=targetClassId; selectClass(targetClassId);} else { loadClassStudents(true);} const firstDate=temp[0]?.date || new Date().toISOString().slice(0,10); const dp=document.getElementById('datePicker'); dp.value=firstDate; dp.dispatchEvent(new Event('change',{bubbles:true})); loadAttendance(); populateClassDropdown(); updateStatusSummary();
  }catch(err){ alert('Import failed: '+err.message); updateDebug('Import error: '+err.message);} }; reader.readAsArrayBuffer(file); };
})();

// ===== Modal & Startup =====
document.getElementById('closeModal').onclick = closeExportModal;

document.addEventListener('DOMContentLoaded',()=>{
  populateClassDropdown();
  document.getElementById('sexMale').checked = true;
  setTodayDate();
  // Keep Import button in sync when user changes dropdown
  document.getElementById('classDropdown').addEventListener('change', function(){ updateButtons(); });
  setTimeout(()=>{ document.getElementById('datePicker').dispatchEvent(new Event('change',{bubbles:true})); },100);
  updateDebug('All features active - Ready!');
});

document.getElementById('datePicker').addEventListener('change',()=>{ if(currentClassId) loadAttendance(); });

function clearDebug(){ document.getElementById('debugInfo').innerHTML='Task log cleared'; }
function importCSV(){ const targetClassId=document.getElementById('classDropdown').value; if(!targetClassId){ alert('Please select a class from the dropdown first.'); return; } const input=document.createElement('input'); input.type='file'; input.accept='.csv,.xlsx,.xls'; input.targetClassId=targetClassId; input.onchange=handleCSVFile; input.click(); }
</script>

<style id="patch21-modal-styles">
  /* Modal date-picker UI (append-only, scoped to #exportModal) */
  #exportModal .modal-content {border-radius: 14px;}
  #exportModal .patch-dates-wrap {display: flex;flex-direction: column;gap: 12px;}
  #exportModal .patch-section {background: #ffffff;border: 1px solid #e6e9f3;border-radius: 10px;max-height: 160px;overflow: auto;padding: 8px 6px;}
  #exportModal .patch-list {list-style: none;margin: 0;padding: 0;}
  #exportModal .patch-item {display: flex;align-items: center;gap: 10px;padding: 8px 10px;border-radius: 8px;white-space: nowrap;}
  #exportModal .patch-item:hover {background: #f6f8ff;}
  #exportModal .patch-item input[type="checkbox"] {width: 16px;height: 16px;cursor: pointer;accent-color: #667eea; /* modern browsers */}
  #exportModal .patch-date-label {font-size: 14px;color: #303244;}
  /* Present Date banner */
  #exportModal .patch-present {display: block;padding: 10px 14px;border-radius: 12px;color: #fff;font-weight: 700;background: linear-gradient(135deg, #667eea, #764ba2);text-align: left;}
  #exportModal .patch-present label {display: inline-flex;align-items: center;gap: 10px;cursor: pointer;}
  #exportModal .patch-present input[type="checkbox"] {width: 18px;height: 18px;accent-color: #fff;cursor: pointer;}
  /* Button row (uses your existing buttons, just spacing) */
  #exportModal .patch-btn-row {display: flex;gap: 12px;justify-content: flex-end;margin-top: 8px;}
  /* Small scrollbars (optional) */
  #exportModal .patch-section::-webkit-scrollbar { height: 8px; width: 8px; }
  #exportModal .patch-section::-webkit-scrollbar-thumb {background: #cfd6e6; border-radius: 10px;}
  #exportModal .patch-section::-webkit-scrollbar-track { background: #f3f5fb; }
</style>
<style id="rm-move-ui-css">
  /* Hard-hide the legacy Move-to-Class UI without deleting nodes (keeps other code safe) */
  #studentClassGroup {display: none !important;visibility: hidden !important;height: 0 !important;overflow: hidden !important;}
  #studentClassGroup * { display: none !important; }</style>
<style id="patch44-css">
  /* Hard-hide the legacy Move-to-Class UI without removing nodes (keeps other code safe) */
  #studentClassGroup { display: none !important; visibility: hidden !important; height: 0 !important; overflow: hidden !important; }
  #studentClassGroup * { display: none !important; }</style>
<style id="patch45-css">
  /* Keep the legacy Move-to-Class UI hard-hidden and inert */
  #studentClassGroup { display:none !important; visibility:hidden !important; height:0 !important; overflow:hidden !important; }
  #studentClassGroup * { display:none !important; }</style>
<style id="patch48-css">
  /* Keep the legacy Move-to-Class UI hard-hidden and inert (safety) */
  #studentClassGroup { display:none !important; visibility:hidden !important; height:0 !important; overflow:hidden !important; }
  #studentClassGroup * { display:none !important; }
  /* Make export-modal dates render one per line without changing your markup */
  #exportModal .date-container label {display: block;margin: 4px 0;cursor: pointer;user-select: none;}
  #exportModal .date-container input[type="checkbox"] {margin-right: .5rem;}</style>


<script id="attendance-consolidated-monkey-patch">
(function(){
  function onReady(fn){
    if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn);
    else fn();
  }

  onReady(function initPatch(){
    /* ------------------ Shared helpers ------------------ */
    function __todayStr(){
      const d = new Date();
      return d.toISOString().split('T')[0];
    }
    function __esc(v){ return String(v).replace(/"/g,'""'); }

    // Ensure selectedDates exists
    if(!Array.isArray(window.selectedDates)) window.selectedDates = [];

    // Safe class resolver (does NOT call selectClass; preserves edit mode)
    function getActiveClassIdEnsureSelected(){
      if(window.currentClassId) return window.currentClassId;
      const dd = document.getElementById('classDropdown');
      const id = dd && dd.value ? dd.value : null;
      if(id){
        window.currentClassId = id; // set silently
        return id;
      }
      return null;
    }

    // Load students fresh from storage for a given class id
    function getStudentsForClass(classId){
      if(!classId) return [];
      try { return JSON.parse(localStorage.getItem(`students-${classId}`) || '[]'); }
      catch { return []; }
    }

    function getStudentExportBtn(){
      return document.querySelector('button[onclick="exportCSV()"]');
    }
    function resetStudentExportBtnLabel(){
      const btn = getStudentExportBtn();
      if(btn){ btn.textContent = 'Export Student'; }
    }

    /* =====================================================
     * Cancel Edit button next to Export
     * ===================================================== */
    function ensureCancelEditButton(){
      const exportBtn = getStudentExportBtn();
      if(!exportBtn || !exportBtn.parentNode) return;

      let cancelBtn = document.getElementById('btnCancelEdit');
      if(!cancelBtn){
        cancelBtn = document.createElement('button');
        cancelBtn.id = 'btnCancelEdit';
        cancelBtn.type = 'button';
        cancelBtn.className = 'edit';
        cancelBtn.style.flex = '1';
        cancelBtn.style.minWidth = '120px';
        cancelBtn.textContent = 'Cancel Edit';
        cancelBtn.title = 'Exit edit mode and clear the student form';
        cancelBtn.disabled = true;
        cancelBtn.addEventListener('click', function(){ window.cancelEdit && window.cancelEdit(); });

        exportBtn.parentNode.insertBefore(cancelBtn, exportBtn.nextSibling);
      }
    }
    window.setCancelEditEnabled = function(on){
      const btn = document.getElementById('btnCancelEdit');
      if(btn) btn.disabled = !on;
    };
    window.setStudentExportEnabled = function(on){
      const btn = getStudentExportBtn();
      if(!btn) return;
      btn.disabled = !on;
      btn.title = on
        ? 'Export this student‚Äôs full attendance history (excluding PENDING)'
        : 'Click ‚úèÔ∏è Edit on a student to enable exporting';
      window.setCancelEditEnabled(!!on);
    };
    window.cancelEdit = function(){
      try{
        // Clear editing state
        window.editingStudentIndex = -1;
        window.editingStudentId = null;

        // Clear form
        const nameInp = document.getElementById('studentName');
        if(nameInp){
          nameInp.value = '';
          delete nameInp.dataset.originalId;
        }
        const sexMale = document.getElementById('sexMale');
        if(sexMale) sexMale.checked = true;

        // Hide legacy move UI (kept hard-hidden in CSS, ensure again)
        const group = document.getElementById('studentClassGroup');
        if(group) group.style.display = 'none';

        // Disable export and cancel; reset label
        window.setStudentExportEnabled(false);
        window.setCancelEditEnabled(false);
        resetStudentExportBtnLabel();

        if(nameInp) nameInp.focus();

        window.updateDebug && window.updateDebug('Edit cancelled.');
      }catch(e){
        alert('Cancel edit failed: ' + e.message);
      }
    };
    ensureCancelEditButton();

    /* =====================================================
     * Export Modal (unchanged behavior from v1.0.2 except class resolve)
     * ===================================================== */
    window.openExportModal = function(){
      const activeId = getActiveClassIdEnsureSelected();
      if(!activeId) return alert('Select a class first!');

      window.selectedDates = []; // reset

      const ds = document.getElementById('dateSelection');
      const today = new Date();
      const todayStr = __todayStr();

      let html = '';

      // FUTURE DATES (top container)
      html += '<div class="date-container" id="futureDates">';
      for(let i=364; i>=1; i--){
        const d = new Date(today);
        d.setDate(today.getDate()+i);
        const s = d.toISOString().split('T')[0];
        const l = d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'});
        html += `<label title="${s}"><input type="checkbox" data-date="${s}" value="${s}" onchange="toggleDate('${s}', this.checked)" style="margin-right:.5rem"> ${l}</label>`;
      }
      html += '</div>';

      // PRESENT DATE (center) ‚Äì default checked
      const presentLabel = today.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'});
      html += `<label class="current-date-center" title="${todayStr}">
        <input id="presentDateCheckbox" type="checkbox" data-date="${todayStr}" value="${todayStr}" onchange="toggleDate('${todayStr}', this.checked)" checked style="margin-right:.5rem">
        Present Date ${presentLabel}
      </label>`;

      // PAST DATES (bottom)
      html += '<div class="date-container" id="pastDates">';
      for(let i=1; i<=365; i++){
        const d = new Date(today);
        d.setDate(today.getDate()-i);
        const s = d.toISOString().split('T')[0];
        const l = d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'});
        html += `<label title="${s}"><input type="checkbox" data-date="${s}" value="${s}" onchange="toggleDate('${s}', this.checked)" style="margin-right:.5rem"> ${l}</label>`;
      }
      html += '</div>';

      ds.innerHTML = html;

      // Default selection = Present Date
      window.selectedDates = [todayStr];

      // Auto-scroll FUTURE container to bottom (visually adjacent to Present Date)
      setTimeout(()=>{
        const futureEl = document.getElementById('futureDates');
        if(futureEl) futureEl.scrollTop = futureEl.scrollHeight;
      }, 0);

      document.getElementById('exportModal').style.display = 'block';
    };

    // Allow any combination of dates (including none)
    window.toggleDate = function(dateStr, checked){
      if(checked){
        if(!window.selectedDates.includes(dateStr)) window.selectedDates.push(dateStr);
      }else{
        window.selectedDates = window.selectedDates.filter(d => d !== dateStr);
      }
    };

    window.confirmExport = function(){
      const activeId = getActiveClassIdEnsureSelected();
      if(!activeId) return alert('Select a class first!');

      if(!Array.isArray(window.selectedDates) || window.selectedDates.length === 0){
        window.selectedDates = [__todayStr()];
      }

      window.closeExportModal && window.closeExportModal();

      // Get class name
      let classes = [];
      try { classes = (typeof window.getAllClasses === 'function' ? window.getAllClasses() : []); } catch {}
      const cls = classes.find(c => c.id === activeId);
      const className = cls ? cls.name : 'unknown';
      const safeClass = className.replace(/[^a-zA-Z0-9_\-]/g,'_');

      // Build student list from storage (not relying on UI state)
      const students = getStudentsForClass(activeId);

      const dates = [...window.selectedDates].sort((a,b)=> a.localeCompare(b));
      const rows = [`"Class","Student","Sex","Status","Date"`];

      for(const dateStr of dates){
        const key = `attendance-${dateStr}-${activeId}`;
        let data = {};
        try{ data = JSON.parse(localStorage.getItem(key) || '{}'); }catch{}
        students.forEach(st => {
          const status = (data[st.id]?.status || 'PENDING').toUpperCase();
          rows.push([
            `"${__esc(className)}"`,
            `"${__esc(st.name)}"`,
            `"${__esc(st.sex)}"`,
            `"${__esc(status)}"`,
            `"${__esc(dateStr)}"`
          ].join(','));
        });
      }

      const csv = rows.join('\r\n');
      let filename = '';
      if(dates.length === 1){
        filename = `${dates[0]}_${safeClass}_attendance.csv`;
      } else {
        filename = `${dates[0]}_to_${dates[dates.length-1]}_${safeClass}_attendance.csv`;
      }

      if(typeof window.downloadFile === 'function'){
        window.downloadFile(csv, filename, 'text/csv');
      }else{
        const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename;
        document.body.appendChild(a); a.click();
        setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
      }
    };

    // Download helper (CRLF)
    window.downloadFile = function(content, filename, mimeType){
      try{
        const txt = Array.isArray(content) ? content.join('\r\n') : String(content);
        const blob = new Blob([txt], { type: mimeType || 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename;
        document.body.appendChild(a); a.click();
        setTimeout(()=>{
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 100);
      }catch(e){
        alert('Download failed: ' + e.message);
      }
    };

    /* =====================================================
     * Delete Student ‚Äì robust index resolution + purge attendance
     * ===================================================== */
    window.deleteStudent = function(index){
      try{
        const activeId = getActiveClassIdEnsureSelected();
        if(!activeId){
          alert('Select a class first.');
          return;
        }

        // Ensure we have a fresh, UI-synced list
        let list = window.currentStudents || [];
        let resolvedIndex = (typeof index === 'number') ? index : -1;

        // If index invalid, try to resolve from the clicked row (using window.event)
        if(resolvedIndex < 0 || resolvedIndex >= list.length){
          const ev = window.event;
          const btn = ev && ev.target ? ev.target.closest('button') : null;
          const row = btn ? btn.closest('tr') : null;
          if(row){
            const tds = row.querySelectorAll('td');
            const nameText = tds && tds[1] ? tds[1].textContent.trim() : '';
            const sexText  = tds && tds[2] ? tds[2].textContent.trim() : '';
            if(nameText && sexText){
              resolvedIndex = list.findIndex(s => s.name === nameText && s.sex === sexText);
            }
          }
        }

        // If still invalid, rebuild list from storage and try again (in case UI was stale)
        if(resolvedIndex < 0 || resolvedIndex >= list.length){
          list = getStudentsForClass(activeId);
          window.currentStudents = list.slice(); // resync
          // Try dataset.originalId (if editing same row)
          const origId = (document.getElementById('studentName') || {}).dataset?.originalId;
          if(origId){
            resolvedIndex = list.findIndex(s => s.id === origId);
          }
        }

        if(resolvedIndex < 0 || resolvedIndex >= list.length){
          alert('Reload class > Selected Class from the dropdown > Edit Student and click Delete.');
          return;
        }

        const s = list[resolvedIndex];
        if(!confirm(`Delete this student and ALL their attendance?\n\n${s.name} (${s.sex})`)) return;

        const sid = s.id;

        // Remove from list and persist
        list.splice(resolvedIndex, 1);
        window.currentStudents = list.slice();
        try { localStorage.setItem(`students-${activeId}`, JSON.stringify(list)); } catch {}

        // Remove attendance across all dates for this class
        const suffix = `-${activeId}`;
        for(const k of Object.keys(localStorage)){
          if(k.startsWith('attendance-') && k.endsWith(suffix)){
            try{
              const att = JSON.parse(localStorage.getItem(k) || '{}');
              if(att && Object.prototype.hasOwnProperty.call(att, sid)){
                delete att[sid];
                if(Object.keys(att).length === 0){
                  localStorage.removeItem(k); // purge empty date
                } else {
                  localStorage.setItem(k, JSON.stringify(att));
                }
              }
            }catch{}
          }
        }

        // If the deleted student was being edited, reset edit/export state
        if(window.editingStudentId === sid || window.editingStudentIndex === resolvedIndex){
          window.setStudentExportEnabled(false);
          window.setCancelEditEnabled(false);
          window.editingStudentIndex = -1;
          window.editingStudentId = null;
          resetStudentExportBtnLabel();

          // Clear form fields if they showed this student
          const nameInp = document.getElementById('studentName');
          if(nameInp){
            nameInp.value = '';
            delete nameInp.dataset.originalId;
          }
          const sexMale = document.getElementById('sexMale');
          if(sexMale) sexMale.checked = true;
        }

        // Refresh UI
        try { window.loadClassStudents && window.loadClassStudents(); } catch {}
        try { window.populateClassDropdown && window.populateClassDropdown(); } catch {}
        try { window.updateDebug && window.updateDebug(`Deleted ${s.name} and removed all their attendance.`); } catch {}
      }catch(err){
        alert('Delete failed: ' + err.message);
      }
    };

    /* =====================================================
     * Delete Class ‚Äì purge all related keys, remove empty classes key
     * ===================================================== */
    window.deleteSelectedClass = function(){
      const dd = document.getElementById('classDropdown');
      const id = dd ? dd.value : null;
      if(!id) return;

      if(!confirm('Delete class and ALL related data?')) return;

      // Remove the class from the list
      let classes = [];
      try {
        classes = (typeof window.getAllClasses === 'function' ? window.getAllClasses() : []).filter(c => c.id !== id);
      }catch{}

      // Remove all related storage keys
      for(const k of Object.keys(localStorage)){
        const isStudentsKey   = (k === `students-${id}`);
        const isAttendanceKey = (k.startsWith('attendance-') && k.endsWith(`-${id}`));
        if(isStudentsKey || isAttendanceKey){
          localStorage.removeItem(k);
        }
      }

      // Update or clear classes key
      if(classes.length > 0){
        localStorage.setItem('attendanceclasses', JSON.stringify(classes));
      } else {
        localStorage.removeItem('attendanceclasses');
      }

      // If the deleted class was active, reset UI sections
      if(window.currentClassId === id){
        window.currentClassId = null;
        const content = document.getElementById('classContent');
        if(content) content.classList.add('disabled');
        const stBody = document.querySelector('#studentTable tbody');
        const atBody = document.querySelector('#attendanceTable tbody');
        if(stBody) stBody.innerHTML = '';
        if(atBody) atBody.innerHTML = '';
        const statBody = document.getElementById('statusTableBody');
        if(statBody) statBody.innerHTML = '';
        const cur = document.getElementById('currentStudent');
        if(cur) cur.textContent = 'Select a Class to begin...';
      }

      // Reset edit/export/cancel state
      try {
        window.setStudentExportEnabled(false);
        window.setCancelEditEnabled(false);
        window.editingStudentIndex = -1;
        window.editingStudentId = null;
        resetStudentExportBtnLabel();
      } catch {}

      try { window.populateClassDropdown && window.populateClassDropdown(); } catch {}
      try { window.updateButtons && window.updateButtons(); } catch {}
      try { window.updateDebug && window.updateDebug('Class deleted and all related data removed.'); } catch {}
    };

    /* =====================================================
     * Keep Export & Cancel in sync with edits
     * ===================================================== */
    document.addEventListener('DOMContentLoaded', () => {
      window.setStudentExportEnabled(false);
      window.setCancelEditEnabled(false);
      ensureCancelEditButton();
    });

    const __orig_selectClass = window.selectClass;
    window.selectClass = function(id){
      // Normal class selection should end edit mode
      window.editingStudentIndex = -1;
      window.editingStudentId = null;
      window.setStudentExportEnabled(false);
      window.setCancelEditEnabled(false);
      resetStudentExportBtnLabel();
      const res = __orig_selectClass ? __orig_selectClass.apply(this, arguments) : undefined;
      ensureCancelEditButton();
      return res;
    };



const __orig_addStudent = window.addStudent;
window.addStudent = function(){
  let res;
  try{
    // Call the original (now made safe)
    res = __orig_addStudent ? __orig_addStudent.apply(this, arguments) : undefined;
  }catch(e){
    // Fail-safe: reset edit/UI to prevent stuck state if anything unexpected happens
    try{
      const nameEl = document.getElementById('studentName');
      if(nameEl){ nameEl.value = ''; delete nameEl.dataset.originalId; }
      const sexMale = document.getElementById('sexMale'); if(sexMale) sexMale.checked = true;
      const group = document.getElementById('studentClassGroup'); if(group) group.style.display = 'none';
    }catch(_){}
    editingStudentIndex = -1;
    editingStudentId = null;
    if(typeof setStudentExportEnabled === 'function') setStudentExportEnabled(false);
    if(typeof setCancelEditEnabled === 'function') setCancelEditEnabled(false);
    if(typeof resetStudentExportBtnLabel === 'function') resetStudentExportBtnLabel();
    console.error('addStudent error (handled):', e);
    alert('Add Student failed: ' + e.message);
    return; // swallow the error after cleanup
  } finally {
    // Keep buttons in sync regardless of success/failure
    if(typeof setStudentExportEnabled === 'function') setStudentExportEnabled(false);
    if(typeof setCancelEditEnabled === 'function') setCancelEditEnabled(false);
    if(typeof resetStudentExportBtnLabel === 'function') resetStudentExportBtnLabel();
    if(typeof ensureCancelEditButton === 'function') ensureCancelEditButton();
  }
  return res;
};


(function(){
  const __orig_deleteStudent = window.deleteStudent;
  if (typeof __orig_deleteStudent !== 'function') return;

  window.deleteStudent = function(index){
    // We‚Äôll check the length before and after to confirm a deletion really happened
    const beforeLen = Array.isArray(window.currentStudents) ? window.currentStudents.length : null;

    // Call the original
    const res = __orig_deleteStudent.apply(this, arguments);

    // Async microtask: after the original finishes and any UI refreshes run
    Promise.resolve().then(()=>{
      const afterLen = Array.isArray(window.currentStudents) ? window.currentStudents.length : null;
      const deleted = (beforeLen != null && afterLen != null && afterLen < beforeLen);

      // Only auto-cancel if we actually deleted someone
      if (deleted) {
        if (typeof window.cancelEdit === 'function') {
          window.cancelEdit();
        } else {
          const cancelBtn = document.getElementById('btnCancelEdit');
          if (cancelBtn) cancelBtn.click();
        }
      }
    });

    return res;
  };
})();


    const __orig_editStudent = window.editStudent;
    window.editStudent = function(index){
      const res = __orig_editStudent ? __orig_editStudent.apply(this, arguments) : undefined;
      window.setStudentExportEnabled(true);
      window.setCancelEditEnabled(true);
      try {
        const btn = getStudentExportBtn();
        const s = (window.currentStudents || [])[window.editingStudentIndex];
        if(btn && s){ btn.textContent = 'Export (' + s.name + ')'; }
      } catch {}
      ensureCancelEditButton();
      return res;
    };

    /* =====================================================
     * Student full‚Äëhistory export EXCLUDING PENDING
     *  - Robust edited student resolution (fix for false alert)
     * ===================================================== */
    function __getEditedStudent(activeId){
      // 1) Trust current edit state if valid
      if(window.editingStudentIndex != null && window.editingStudentIndex > -1){
        const s = (window.currentStudents || [])[window.editingStudentIndex];
        if(s && (!window.editingStudentId || window.editingStudentId === s.id)){
          return { student: s, index: window.editingStudentIndex };
        }
      }

      // 2) Use dataset.originalId if present
      const nameInp = document.getElementById('studentName');
      const origId = nameInp && nameInp.dataset ? nameInp.dataset.originalId : null;
      if(origId){
        const list = window.currentStudents && window.currentStudents.length ? window.currentStudents : getStudentsForClass(activeId);
        const idx = list.findIndex(x => x.id === origId);
        if(idx > -1) return { student: list[idx], index: idx };
      }

      // 3) Parse from Export button label "Export (Name)"
      const btn = getStudentExportBtn();
      if(btn && /\bExport \((.+)\)\b/.test(btn.textContent)){
        const name = btn.textContent.match(/\bExport \((.+)\)\b/)[1];
        const list = window.currentStudents && window.currentStudents.length ? window.currentStudents : getStudentsForClass(activeId);
        const idx = list.findIndex(x => x.name === name);
        if(idx > -1) return { student: list[idx], index: idx };
      }

      return { student: null, index: -1 };
    }

    window.exportCSV = function(){
      try{
        const activeId = getActiveClassIdEnsureSelected();
        if(!activeId){
          alert('Select a class first!');
          return;
        }

        const { student: s, index: idx } = __getEditedStudent(activeId);
        if(!s || idx < 0){
          alert('Click ‚úèÔ∏è Edit on a student to enable Export.');
          return;
        }

        // Get class name
        let classes = [];
        try { classes = (typeof window.getAllClasses === 'function' ? window.getAllClasses() : []); } catch {}
        const cls = classes.find(c => c.id === activeId);
        const className = cls ? cls.name : 'Unknown Class';

        // Gather all class dates
        const allDates = [];
        for(const k of Object.keys(localStorage)){
          if(k.startsWith('attendance-') && k.endsWith(`-${activeId}`)){
            const parts = k.split('-'); // ["attendance","YYYY","MM","DD","<classId>"]
            if(parts.length >= 5){
              const dateStr = parts.slice(1,4).join('-');
              if(/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) allDates.push(dateStr);
            }
          }
        }
        allDates.sort((a,b)=> a.localeCompare(b));

        const rows = [`"Class","Student","Sex","Status","Date"`];
        let count = 0;

        for(const dateStr of allDates){
          const key = `attendance-${dateStr}-${activeId}`;
          let att = {};
          try{ att = JSON.parse(localStorage.getItem(key) || '{}'); }catch{}
          const raw = (att[s.id]?.status || 'PENDING');
          const status = String(raw).toUpperCase();
          if(status !== 'PENDING'){
            count++;
            rows.push([
              `"${__esc(className)}"`,
              `"${__esc(s.name)}"`,
              `"${__esc(s.sex)}"`,
              `"${__esc(status)}"`,
              `"${__esc(dateStr)}"`
            ].join(','));
          }
        }

        if(count === 0){
          alert(`No non-PENDING attendance records found for "${s.name}".`);
          try { window.updateDebug && window.updateDebug(`Export skipped: no non-PENDING rows for "${s.name}".`); } catch {}
          return;
        }

        const safeClass = className.replace(/[^a-zA-Z0-9_\-]/g,'_');
        const safeName  = s.name.replace(/[^a-zA-Z0-9_\-]/g,'_');
        const filename  = `${safeClass}_${safeName}_attendance_no_pending.csv`;
        const csv = rows.join('\r\n');

        if(typeof window.downloadFile === 'function'){
          window.downloadFile(csv, filename, 'text/csv');
        }else{
          const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = filename;
          document.body.appendChild(a); a.click();
          setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
        }

        try { window.updateDebug && window.updateDebug(`Exported ${count} row(s) for "${s.name}" (excluding PENDING).`); } catch {}
      }catch(err){
        alert('Export failed: ' + err.message);
        try { window.updateDebug && window.updateDebug('Export error: ' + err.message); } catch {}
      }
    };

    // Ensure modal close button still closes modal
    const closeBtn = document.getElementById('closeModal');
    if(closeBtn && typeof window.closeExportModal === 'function'){
      closeBtn.onclick = window.closeExportModal;
    }
  });
})();
</script>

<!-- Floating Action Buttons -->
<button id="fabRefresh" class="fab fab-refresh" title="Refresh (soft)">üîÑ</button>
<button id="fabHelp" class="fab fab-help" title="Help &amp; EULA">‚ùî</button>


<!-- Help + EULA Modal -->
<div id="helpModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="helpModalTitle" aria-modal="true" style="display:none">
  <div class="modal-content">
    <div class="close-row">
      <div class="title">
        <span style="font-size:1.35rem;">üìò</span>
        <h2 id="helpModalTitle" style="margin:0;">Help &amp; EULA</h2>
      </div>
      <button id="helpCloseBtn" class="danger" style="padding:.35rem .7rem" aria-label="Close help">‚úï</button>
    </div>

    <!-- UPDATED: version text -->
    <div class="meta">Version: <strong>v1.1</strong> ¬∑ Storage: <strong>Browser localStorage</strong> ¬∑ Works offline</div>

    <div class="content">
      <h3>Overview</h3>
      <p>ClassTapMark helps you manage classes, add students, and record daily attendance with quick status buttons. Data is stored in your browser via <em>localStorage</em>, so it‚Äôs device &amp; browser‚Äëspecific.</p>

      <h3>Quick Start</h3>
      <ol>
        <li><strong>Create a Class</strong> with <em>üìö Create Class</em>. Then use <em>Load Class</em>.</li>
        <li><strong>Add Students</strong> using the format: <em>Last Name, First Name Middle Name</em> (your preferred convention). Set Sex: <em>Male / Female</em>.</li>
        <li><strong>Mark Attendance</strong> ‚Äî pick a date, navigate students (‚è™ ‚óÄ ‚ñ∂ ‚è©), and choose a status: <em>Present, Absent, Tardy, Cutting, Excuse, Pending</em>.</li>
        <li><strong>Import</strong> <span class="kbd">.csv</span> with columns: <span class="kbd">"Class","Student","Sex","Status","Date"</span>.</li>
        <li><strong>Export CSV</strong>:
          <ul>
            <li><em>Class export</em> (üì• Export CSV): choose one or multiple dates ‚Üí downloads one CSV (CRLF line breaks, Excel‚Äëfriendly).</li>
            <li><em>Student export</em> (while editing): downloads that student‚Äôs full history <strong>excluding PENDING</strong>.</li>
          </ul>
        </li>
      </ol>

      <!-- NEW: Date Import Tips -->
      <h3>üìÖ Date Import Issues</h3>
      <ul>
        <li><strong>Recommended: Use CSV for imports.</strong> Keep the Date column as text in <strong>YYYY‚ÄëMM‚ÄëDD</strong>. This prevents time‚Äëzone conversion. </li>
        <li><strong>In Excel, force YYYY‚ÄëMM‚ÄëDD before saving CSV:</strong> add a helper column with <span class="kbd">=TEXT(E2,"yyyy-mm-dd")</span>, then <em>Copy ‚Üí Paste Special ‚Üí Values</em> back into your Date column.</li>
        <li><strong>Don‚Äôt reopen CSV in Excel</strong> just to check it‚ÄîExcel may re‚Äëinterpret dates based on regional settings. If you need to verify, open the file in Notepad.</li>
        <li><strong>If using .xlsx:</strong> ensure your Date cells are dates (no time). If a shift still appears after import, resave the sheet as CSV using the steps above and re‚Äëimport.</li>
        <li><strong>Note:</strong> The classic Excel 1900/1904 setting causes ~4‚Äëyear differences, not a 1‚Äëday shift.</li>
      </ul>

      <h3>FAQ</h3>
      <ul>
        <li><strong>Date picker format not YYYY-MM-DD.</strong> In Windows 11 open Settings > Date & time > Format > Short date and select YYYY-MM-DD. ClassTapMark conforms with ISO 8601</li>
        <li><strong>Export is disabled.</strong> Click <em>‚úèÔ∏è Edit</em> on a student to enable the student export. For class export, use the main <em>üì• Export CSV</em> button.</li>
        <li><strong>Where is data stored?</strong> In browser <em>localStorage</em> on this device only. Clearing site data or switching browsers/devices will remove it.</li>
        <li><strong>Can I combine multiple dates in one CSV?</strong> Yes‚Äîselect multiple dates in the Export modal; the app generates one combined CSV.</li>
        <li><strong>Why is the Date a number in my sheet?</strong> That‚Äôs an Excel serial date; the importer understands it and converts it to YYYY‚ÄëMM‚ÄëDD.</li>

        <!-- NEW: explicit 1-day shift FAQ -->
        <li><strong>My imported dates shifted one day back.</strong> This is caused by time‚Äëzone conversion when spreadsheets export or interpret date‚Äëonly values as full datetimes. 
          <em>Fix:</em> Import CSV with the Date column as <strong>YYYY‚ÄëMM‚ÄëDD</strong> text (see Date Import Tips). <strong>Best: stick to CSV</strong> when importing.</li>

        <li><strong>How do I delete a student &amp; their attendance?</strong> Click <em>üóëÔ∏è</em>. The app removes the student and purges their attendance records (and cleans up empty date keys).</li>
        <li><strong>Soft vs. Hard Refresh?</strong> Use üîÑ (upper‚Äëleft). Click = Soft refresh UI; <span class="kbd">Shift</span>+Click = Hard reload page.</li>
        <li><strong>Reset everything?</strong> Delete classes or clear site data (this wipes localStorage). Export first if you need a backup.</li>
      </ul>

      <h3>Troubleshooting</h3>
      <ul>
        <li>After importing, if you don‚Äôt see updates: pick the date you imported, or üîÑ refresh.</li>
        <li>If a control looks stuck, use üîÑ soft refresh; if still stuck, <span class="kbd">Shift</span>+Click üîÑ for hard reload.</li>

        <!-- NEW: concrete CSV checklist -->
        <li><strong>CSV import checklist:</strong> (1) Date is <em>YYYY‚ÄëMM‚ÄëDD</em> text; (2) File saved as CSV (UTF‚Äë8); (3) Verified in Notepad; (4) Re‚Äëimport.</li>
      </ul>

      <div class="eula">
        <h3>End‚ÄëUser License Agreement (EULA)</h3>
        <p><em>Last updated:</em> <span id="eulaDate"></span></p>
        <ol>
          <li><strong>License.</strong> You are granted a non‚Äëexclusive, non‚Äëtransferable license to use this ClassTapMark application for personal, classroom, or internal school purposes.</li>
          <li><strong>Ownership.</strong> The application and its components remain the property of the author. This EULA does not transfer any intellectual property rights.</li>
          <li><strong>Data &amp; Storage.</strong> All records are stored locally in your browser‚Äôs <em>localStorage</em>. You are solely responsible for backups and exports.</li>
          <li><strong>Acceptable Use.</strong> Do not use this software for unlawful purposes or to process sensitive personal data without consent or lawful basis.</li>
          <li><strong>No Warranty.</strong> The application is provided ‚ÄúAS IS‚Äù, without warranties of any kind. Use at your own risk.</li>
          <li><strong>Limitation of Liability.</strong> To the maximum extent permitted by law, the author will not be liable for any indirect, incidental, special, consequential, or punitive damages, or any loss of data, even if advised of the possibility.</li>
          <li><strong>Support.</strong> Support is provided on a best‚Äëeffort basis and may be discontinued at any time.</li>
          <li><strong>Termination.</strong> This license terminates if you breach this EULA. Upon termination, stop using the app and delete any related data as required.</li>
          <li><strong>Changes.</strong> The EULA may be updated. Continued use after changes constitutes acceptance of the revised terms.</li>
          <li><strong>Governing Law.</strong> This EULA is governed by the laws applicable in your jurisdiction unless otherwise agreed in writing.</li>
        </ol>
        <p style="font-size:.9rem;color:#555">For further queries contact:<a href=" mailto:esv.tnt010@gmail.com?subject=ClassTapMark"> esv.tnt010@gmail.com</a></p>
      </div>
    </div>

    <div style="display:flex; gap:.6rem; justify-content:flex-end; margin-top: .75rem;">
      <button class="edit" id="helpPrintBtn" title="Print or Save as PDF">Print</button>
      <button class="primary" id="helpCloseBtn2">Close</button>
    </div>
  </div>
</div>


<script id="patch-help-fab-js">
(function(){
  function onReady(fn){
    if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn);
    else fn();
  }

  onReady(function(){
    /* Elements */
    const fabRefresh = document.getElementById('fabRefresh');
    const fabHelp    = document.getElementById('fabHelp');
    const helpModal  = document.getElementById('helpModal');
    const helpClose  = document.getElementById('helpCloseBtn');
    const helpClose2 = document.getElementById('helpCloseBtn2');
    const helpPrint  = document.getElementById('helpPrintBtn');

    /* EULA date */
    const eulaDateEl = document.getElementById('eulaDate');
    if(eulaDateEl){
      const d = new Date();
      eulaDateEl.textContent = d.toLocaleDateString(undefined, { year:'numeric', month:'long', day:'numeric' });
    }

    /* Soft refresh: re-hydrate UI without full page reload */
    function softRefresh(){
      try {
        // Keep current class & date; just re-render from storage
        if(typeof populateClassDropdown === 'function') populateClassDropdown();
        if(window.currentClassId){
          if(typeof loadClassStudents === 'function') loadClassStudents();
          if(typeof updateStatusSummary === 'function') updateStatusSummary();
          if(typeof updateCurrentStudent === 'function') updateCurrentStudent();
          // Refresh attendance for the current date if set
          const dateVal = document.getElementById('datePicker')?.value;
          if(dateVal && typeof loadAttendance === 'function') loadAttendance();
        }
        if(typeof updateDebug === 'function') updateDebug('UI soft-refreshed.');
      } catch(e){
        console.error('Soft refresh error:', e);
      }
    }

    /* Hard reload (Shift+Click) */
    function hardReload(){
      window.location.reload();
    }

    /* Bind FAB: Refresh */
    if(fabRefresh){
      fabRefresh.addEventListener('click', (ev)=>{
        if(ev.shiftKey) hardReload();
        else softRefresh();
      });
      fabRefresh.addEventListener('contextmenu', (ev)=>{
        ev.preventDefault();
        hardReload();
      });
    }

    /* Modal open/close helpers */
    function openHelp(){
      if(helpModal){
        helpModal.style.display = 'block';
        helpModal.setAttribute('aria-hidden', 'false');
      }
    }
    function closeHelp(){
      if(helpModal){
        helpModal.style.display = 'none';
        helpModal.setAttribute('aria-hidden', 'true');
      }
    }

    /* Bind FAB: Help */
    if(fabHelp){ fabHelp.addEventListener('click', openHelp); }
    if(helpClose){ helpClose.addEventListener('click', closeHelp); }
    if(helpClose2){ helpClose2.addEventListener('click', closeHelp); }
    if(helpPrint){ helpPrint.addEventListener('click', ()=> window.print()); }

    /* Close on outside click */
    if(helpModal){
      helpModal.addEventListener('click', (e)=>{
        if(e.target === helpModal) closeHelp();
      });
    }
    /* Close on Escape */
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape' && helpModal && helpModal.style.display === 'block'){
        closeHelp();
      }
    });
  });
})();
</script>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('/ClassTapMark/sw.js')
      .then(function(reg) { console.log('SW registered!'); })
      .catch(function(err) { console.log('SW registration failed:', err); });
  });
}
</script>
</body>
</html>
