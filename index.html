<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="ClassTapMark helps you manage classes, add students, and record daily attendance with quick status buttons." />
  <meta name="theme-color" content="#667eea" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="msapplication-TileImage" content="icon192x192.png" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/png" sizes="32x32" href="image/favicon-32.png" />
  <link rel="apple-touch-icon" sizes="192x192" href="icon192x192.png" />
  <title>ClassTapMark</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- ============ Theme & Layout (consolidated) ============ -->
  <style>
    * { box-sizing: border-box }
    :root{
      --bg1:#667eea; --bg2:#764ba2; --panel:#ffffff; --muted:#e8ecf4; --text:#222;
      --shadow:0 8px 32px rgba(0,0,0,.10);
      --radius:16px;
    }
    html,body{height:100%}
    body{
      margin:0; padding:1rem;
      font:16px/1.45 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:linear-gradient(135deg,var(--bg1),var(--bg2)); color:var(--text);
    }
    .container{max-width:1200px;margin:0 auto}
    h1{color:#fff;text-align:center;margin:0 0 1.25rem}
    .section{background:var(--panel);border-radius:var(--radius);padding:1.25rem;margin:1rem 0;box-shadow:var(--shadow)}

    label,input,select,button{font-family:inherit}
    input,select{padding:.8rem 1rem;border:2px solid #e1e5e9;border-radius:12px;background:#fafbff;transition:.2s}
    input:focus,select:focus{outline:none;border-color:var(--bg1);box-shadow:0 0 0 3px rgba(102,126,234,.12)}

    button{padding:.8rem 1.1rem;border:none;border-radius:12px;font-weight:500;cursor:pointer;transition:.2s}
    button.primary{background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#fff}
    button.edit{background: linear-gradient(135deg, #667eea, #764ba2); color: #fff;}
    button.danger{background:linear-gradient(135deg,#ff6b6b,#ee5a52);color:#fff}
    button:hover{transform:translateY(-1px);box-shadow:0 10px 22px rgba(0,0,0,.18)}
    button:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}

    table{width:100%;border-collapse:collapse;margin:1rem 0;border-radius:12px;overflow:hidden;background:#fff;box-shadow:0 6px 18px rgba(0,0,0,.08)}
    th,td{padding:.75rem .65rem;text-align:left;border-bottom:1px solid var(--muted);font-size:.95rem}
    th{background:linear-gradient(135deg,#f0f4ff,#e8f0ff);font-weight:700}

    /* Compact tables (from old) */
    #studentTable, #attendanceTable, #statusTable { font-size: 0.8rem; }
    #studentTable th, #studentTable td, #attendanceTable th, #attendanceTable td,
	#statusTable th, #statusTable td,	{ padding: 0.5rem 0.375rem; font-size: 0.75rem; }
    @media (max-width: 500px) {
      #studentTable, #attendanceTable, #statusTable { font-size: .7rem; }
      #studentTable th, #studentTable td, #attendanceTable th, #attendanceTable td, #statusTable th, #statusTable td { padding: .4rem .25rem; font-size: .65rem; }
    }

    /* Nav row */
    .nav-row{display:flex;gap:.75rem;align-items:center;justify-content:center;background:rgba(255,255,255,.95);border-radius:12px;padding:.5rem 1rem;margin:1rem 0;box-shadow:0 6px 18px rgba(0,0,0,.12)}
    .nav-btn{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#fff;font-size:1rem;display:flex;align-items:center;justify-content:center}
    .nav-btn:hover{transform:scale(1.06)}

    /* Status buttons */
    .status-row{display:flex;gap:.5rem;justify-content:center;flex-wrap:wrap;margin:1rem 0}
    .status-btn{border:2px solid #dee2e6;background:#f8f9fa;color:#333;min-width:82px}
    .status-btn.present{background:#28a745;color:#fff;border-color:#20c997}
    .status-btn.absent{background:#dc3545;color:#fff;border-color:#c82333}
    .status-btn.tardy{background:#e0a800;color:#212529;border-color:#d97706}
    .status-btn.cutting{background:#fd7e14;color:#fff;border-color:#f06b00}
    .status-btn.excuse{background:linear-gradient(135deg,#20c997,#17a2b8);color:#fff;border-color:#138496}
    .status-btn.pending{background:#ff9500;color:#fff;border-color:#e68900}

	.status-row {display: flex;flex-wrap: wrap;gap: 8px;width: 100%;padding: 8px;box-sizing: border-box;}
	
	.status-btn {flex: 1 1 calc(16.666% - 8px); /* 6 buttons = ~16.67% each */min-width: 80px;padding: 12px 8px;border: 1px solid #ccc;border-radius: 6px;background: #f8f9fa;cursor: pointer;font-size: 14px;white-space: nowrap;transition: all 0.2s ease;}

	/* Tablet: 3 buttons per row */
	@media (max-width: 768px) {.status-btn {flex: 1 1 calc(33.333% - 6px); /* 3 buttons = ~33.33% each */}}	

    /* Current student highlight */
    .currentStudent{background:linear-gradient(135deg,#ffecd2,#fcb69f);padding:1rem;border-radius:12px;text-align:center}

    /* Debug panel */
    .debug{background:linear-gradient(135deg,#fff3cd,#ffeaa7);padding:.8rem;border-radius:12px;font:13px/1.35 ui-monospace,Consolas,monospace;max-height:160px;overflow:auto}

    /* Export modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;z-index:1000}
    .modal .modal-content{background:#fff;margin:8% auto;padding:1.25rem;border-radius:16px;width:92%;max-width:560px;max-height:80vh;overflow:auto;box-shadow:var(--shadow)}
    .date-container{border:1px solid #e1e5e9;border-radius:8px;padding:.6rem;background:#fafbff;max-height:160px;overflow:auto;margin:.35rem 0}
    .current-date-center{display:block;padding:.7rem;border-radius:10px;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#fff;text-align:center}
    /* One date per line */
    #exportModal .date-container label{display:block;margin:4px 0;cursor:pointer;user-select:none}
    #exportModal .date-container input[type="checkbox"]{margin-right:.5rem}

    /* Lock UI: while locked show ONLY Access Control; hide rest inside .container */
    body.locked .container > :not(#accessControl){display:none !important}
    /* still hide Export modal while locked */
    body.locked #exportModal{display:none !important}

    /* License status color */
    #proStatus.ok { color:#10b981; }
    #proStatus.err { color:#ef4444; }

    /* Buy/Register paragraph visibility: show only when locked */
    #ctmBuy, #ctmBuy + div { display: none !important; }
    body.locked #ctmBuy, body.locked #ctmBuy + div { display: block !important; }

    /* ==== HELP FAB + HELP MODAL ==== */
    .fab {
      position: fixed;
      top: 14px;
      width: 46px;
      height: 46px;
      border: none;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      color: #fff;
      font-weight: 800;
      font-size: 18px;
      cursor: pointer;
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      z-index: 1200;
      transition: transform .15s ease, box-shadow .15s ease, opacity .2s ease;
    }
    .fab:hover { transform: translateY(-1px) scale(1.04); }
    .fab:active { transform: scale(0.97); }
    .fab:focus { outline: none; box-shadow: 0 0 0 4px rgba(102,126,234,.20); }
    .fab[disabled] { opacity: .55; cursor: not-allowed; transform: none; }
    .fab-help { right: 14px; }
    /* DO NOT hide help while locked (kept accessible). */

    /* Help modal tweaks (reuse .modal) */
    #helpModal .modal-content { margin: 6% auto; max-width: 820px; }
    #helpModal .close-row { display:flex; justify-content:space-between; align-items:center; gap:.75rem; margin-bottom:.5rem; }
    #helpModal .close-row .title {
      display:flex; align-items:center; gap:.6rem;
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
      font-weight: 800;
    }
    #helpModal .meta { color:#667; font-size:.9rem; margin-bottom:.75rem; }
    #helpModal .kbd {
      background:#eef2ff; border:1px solid #dfe6ff; border-radius:6px; padding:0 .35rem;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size:.85em;
    }
    #helpModal .eula {
      border-top: 1px solid #e8ecf4; margin-top: 1rem; padding-top: 1rem;
      background: #fafbff; border-radius: 10px; padding: 1rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ClassTapMark</h1>

    <!-- Access Control (License) -->
    <div class="section" id="accessControl" style="display:flex;gap:.6rem;flex-wrap:wrap;width:100%;">
      <h3 id="proStatus"></h3>
      <div style="display:flex;gap:.6rem;flex-wrap:wrap;width:100%;">
        <input id="proEmail" type="email" placeholder="your@email.com" style="flex:1;">
        <input id="proLicense" type="text" placeholder="License Key" style="flex:1;">
        <input id="proSignature" type="text" placeholder="Signature" style="flex:1">
      </div>
      <button class="danger" id="proClear" style="flex:1;">Clear License</button>
      <button class="primary" id="proValidate" style="flex:1;">Unlock</button>
      <div style="display:flex;gap:.6rem;flex-wrap:wrap;width:100%;">
        <p id="ctmBuy">
          <b>ClassTapMark</b> helps you manage classes, add students, and record daily attendance with quick status buttons.
          Import and Export Students and Classes as CSV for backup and migration. Data is stored in your browser via
          <em>localStorage</em> ‚Äî device & browser specific. Works offline.
          <br />
          <div style="display:flex;gap:0.6rem;flex-wrap:wrap;justify-content:center;width:100%;align-items:center;">
            <input type="button" onclick="location.href='https://www.raket.ph/esvillamor';" value="Buy Now" />
            <input type="button" onclick="location.href='https://www.raket.ph/esvillamor';" value="Register" />
          </div>
        </p>
      </div>
    </div>

    <!-- Manage Classes -->
    <div class="section">
      <h3>üìö Manage Classes</h3>
      <div style="display:flex;gap:.6rem;flex-wrap:wrap">
        <input id="className" placeholder="Enter Class Name eg. Gr7-A" style="flex:2;min-width:220px">
        <button class="primary" onclick="addClass()">Create Class</button>
      </div>
      <div style="margin:.6rem 0">
        <select id="classDropdown" style="width:100%"><option value="">Select Class</option></select>
      </div>
      <div style="display:flex;gap:.6rem;flex-wrap:wrap;width:100%;">
        <button class="primary" id="btnSelectClass" style="flex:1;" onclick="selectClassFromDropdownWithCreate()">Load Class</button>
        <button class="edit" id="btnEditClass" style="flex:1;" disabled onclick="editClass()">Edit Class</button>
        <button class="danger" id="btnDeleteClass" style="flex:1;" disabled onclick="deleteSelectedClass()">Delete Class</button>
      </div>
    </div>

    <!-- Manage Students -->
    <div id="classContent" class="section disabled">
      <h3>üë• Manage Students</h3>
      <span id="classHeader" style="font-weight:600;background:linear-gradient(135deg,var(--bg1),var(--bg2));-webkit-background-clip:text;-webkit-text-fill-color:transparent">[Class Name]</span>

      <div class="student-form">
        <div style="display:flex;justify-content:center;gap:1rem;align-items:end;flex-wrap:wrap;margin:.6rem 0">
          <input id="studentName" placeholder="Last Name, First Name Middle Name" style="flex:2;min-width:240px;max-width:600px">
        </div>

        <div style="display:flex; justify-content:center; flex-direction:column; align-items:center; gap:1rem; padding:1rem;">
          <div style="display:flex; gap:1rem; align-items:end; flex-wrap:wrap;">
            <label style="display:flex;align-items:center;gap:.35rem"><input type="radio" name="studentSex" value="Male" id="sexMale" checked> Male</label>
            <label style="display:flex;align-items:center;gap:.35rem"><input type="radio" name="studentSex" value="Female" id="sexFemale"> Female</label>
          </div>

          <div style="display:flex; gap:0.6rem; flex-wrap:wrap; justify-content:center; width:100%; align-items:center;">
            <button class="primary" style="flex:1; min-width:120px;" onclick="importCSV()" title="Select a class from the dropdown to enable importing">Import</button>
			<button class="primary" style="flex:1; min-width:120px;" onclick="addStudent()">Add Student</button>
			<button id="btnCancelEdit" class="edit" style="flex:1; min-width:120px;" onclick="cancelEdit()" disabled>Cancel Edit</button>
          </div>
          <div style="display:flex; gap:0.6rem; flex-wrap:wrap; justify-content:center; width:100%; align-items:center;">
            <!-- Per-student export (enabled in edit mode) -->
            <button class="primary" style="flex:1; min-width:120px;" onclick="exportCSV()" title="Click Edit ‚úèÔ∏è to Export Student"  disabled id="btnExportStudent">Export</button>
          </div>
        </div>
      </div>

      <table id="studentTable">
        <thead>
          <tr>
            <th style="width:3%">#</th>
            <th style="width:32%">Name</th>
            <th style="width:10%">Sex</th>
            <th style="width:20%">Added</th>
            <th style="width:35%">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Mark Attendance -->
    <div class="section">
      <h3>üìÖ Mark Attendance</h3>
      <span id="attendanceClassHeader" style="font-weight:600;background:linear-gradient(135deg,var(--bg1),var(--bg2));-webkit-background-clip:text;-webkit-text-fill-color:transparent">[Class Name]</span>

      <!-- Daily status summary (by sex) -->
      <div>
        <table id="statusTable">
          <thead>
            <tr><th>Sex</th><th>Present</th><th>Absent</th><th>Tardy</th><th>Cutting</th><th>Excuse</th><th>Pending</th></tr>
          </thead>
          <tbody id="statusTableBody"></tbody>
        </table>
      </div>

      <div id="currentStudent" class="currentStudent">Select a Class to begin</div>

      <div class="status-row">
        <button class="status-btn" onclick="markAttendance('present')">Present</button>
        <button class="status-btn" onclick="markAttendance('absent')">Absent</button>
        <button class="status-btn" onclick="markAttendance('tardy')">Tardy</button>
        <button class="status-btn" onclick="markAttendance('cutting')">Cutting</button>
        <button class="status-btn" onclick="markAttendance('excuse')">Excuse</button>
        <button class="status-btn" onclick="markAttendance('pending')">Pending</button>
      </div>

      <div class="nav-row">
        <input type="date" id="datePicker" style="min-width:160px">
        <button class="nav-btn" onclick="navigateStudent('first')" title="First">‚è™</button>
        <button class="nav-btn" onclick="navigateStudent('prev')" title="Previous">‚óÄ</button>
        <button class="nav-btn" onclick="navigateStudent('next')" title="Next">‚ñ∂</button>
        <button class="nav-btn" onclick="navigateStudent('last')" title="Last">‚è©</button>
      </div>

      <table id="attendanceTable">
        <thead>
          <tr><th>#</th><th>Student</th><th style="width:10%">Sex</th><th>Status</th><th style="width:20%">Date</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="section">
      <div style="display:flex; gap:0.6rem; flex-wrap:wrap; justify-content:space-between; width:100%; margin:0; padding:0;">
        <button class="primary" onclick="openExportModal()" style="flex:1; min-width:150px;">üì• Export CSV</button>
        <button class="primary" onclick="clearDebug()" style="flex:1; min-width:150px;">üßπ Clear Tasks Log</button>
      </div>
      <div id="debugInfo" class="debug">Task log will appear here</div>

      <!-- Export Modal -->
      <div id="exportModal" class="modal" style="display:none">
        <div class="modal-content">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;">
            <h3>Select Dates for Export</h3>
            <button id="closeModal" class="danger" style="padding:.25rem .6rem" onclick="closeExportModal()">‚úï</button>
          </div>
          <div id="dateSelection"></div>
          <div style="display:flex;gap:.6rem;justify-content:flex-end;margin-top:.6rem">
            <button id="cancelExport" class="edit" onclick="closeExportModal()">Cancel</button>
            <button id="confirmExport" class="primary" onclick="confirmExport()">Export Selected</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating Help FAB (outside .container so it's visible even when locked) -->
  <button id="fabHelp" class="fab fab-help" title="Help & EULA">‚ùì</button>

  <!-- Help & EULA Modal (also outside .container) -->
  <div id="helpModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="helpModalTitle" aria-modal="true" style="display:none">
    <div class="modal-content">
      <div class="close-row">
        <div class="title">
          <span style="font-size:1.35rem;">üìò</span>
          <h2 id="helpModalTitle" style="margin:0;">Help & EULA</h2>
        </div>
        <button id="helpCloseBtn" class="danger" style="padding:.35rem .7rem" aria-label="Close help">‚úï</button>
      </div>

      <div class="meta">Version: <strong>v1.1</strong> ¬∑ Storage: <strong>Browser localStorage</strong> ¬∑ Works offline</div>

      <div class="content">
        <h3>Overview</h3>
        <p>ClassTapMark helps you manage classes, add students, and record daily attendance with quick status buttons. Data is stored in your browser via <em>localStorage</em>, so it‚Äôs device & browser‚Äëspecific.</p>

        <h3>Quick Start</h3>
        <ol>
          <li><strong>Create a Class</strong> with <em>üìö Create Class</em>. Then use <em>Load Class</em>.</li>
          <li><strong>Add Students</strong> using the format: <em>Last Name, First Name Middle Name</em>. Set Sex: <em>Male / Female</em>.</li>
          <li><strong>Mark Attendance</strong>‚Äîpick a date, navigate students (‚è™ ‚óÄ ‚ñ∂ ‚è©), and choose a status: <em>Present, Absent, Tardy, Cutting, Excuse, Pending</em>.</li>
          <li><strong>Import</strong> <span class="kbd">.csv</span> with columns: <span class="kbd">"Class","Student","Sex","Status","Date"</span>.</li>
          <li><strong>Export CSV</strong>:
            <ul>
              <li><em>Class export</em> (üì• Export CSV): choose one or multiple dates ‚Üí downloads one CSV.</li>
              <li><em>Student export</em> (while editing): downloads that student‚Äôs full history <strong>excluding PENDING</strong>.</li>
            </ul>
          </li>
        </ol>

        <h3>Import Tips</h3>
        <ul>
          <li><strong>Recommended: Use CSV for imports.</strong> Keep the Date column as text in <strong>YYYY‚ÄëMM‚ÄëDD</strong>.</li>
		  <li><strong>Import only the exported CSV...</strong></li>
          <li><strong>Don‚Äôt reopen CSV in Excel</strong> just to check it‚Äîuse a text editor to avoid date re‚Äëparsing or do not save changes made in Excel.</li>
        </ul>

        <h3>FAQ</h3>
        <ul>
          <li><strong>Date picker format not YYYY-MM-DD.</strong> In Windows 11 open Settings > Date & time > Format > Short date and select YYYY-MM-DD. ClassTapMark conforms with ISO 8601</li>
          <li><strong>Why is the Date a number in my sheet?</strong> That‚Äôs an Excel serial date; the importer understands it and converts it to YYYY‚ÄëMM‚ÄëDD.</li>
          <li><strong>My imported dates shifted one day back.</strong> This is caused by time‚Äëzone conversion when spreadsheets export or interpret date‚Äëonly values as full datetimes. 
          <strong>Best: stick to CSV</strong> when importing.</li>
          <li><strong>How do I delete a student &amp; their attendance?</strong> Click <em>üóëÔ∏è</em>. The app removes the student and purges their attendance records.</li>
          <li><strong>Reset everything?</strong> Delete classes or clear site data (this wipes localStorage). Export first if you need a backup.</li>		  
		  <li><strong>Why is Export disabled?</strong> Click <em>‚úèÔ∏è Edit</em> on a student to enable the student export. Class export uses the main <em>üì• Export CSV</em> button.</li>
          <li><strong>Where is data stored?</strong> Browser <em>localStorage</em> on this device only.</li>
          <li><strong>Combine multiple dates?</strong> Yes‚Äîselect multiple dates in the Export modal; one combined CSV will be generated.</li>
        </ul>

        <div class="eula">
        <h3>End‚ÄëUser License Agreement (EULA)</h3>
        <p><em>Last updated:</em> <span id="eulaDate"></span></p>
        <ol>
          <li><strong>License.</strong> You are granted a non‚Äëexclusive, non‚Äëtransferable license to use this ClassTapMark application for personal, classroom, or internal school purposes.</li>
          <li><strong>Ownership.</strong> The application and its components remain the property of the author. This EULA does not transfer any intellectual property rights.</li>
          <li><strong>Data &amp; Storage.</strong> All records are stored locally in your browser‚Äôs <em>localStorage</em>. You are solely responsible for backups and exports.</li>
          <li><strong>Acceptable Use.</strong> Do not use this software for unlawful purposes or to process sensitive personal data without consent or lawful basis.</li>
          <li><strong>No Warranty.</strong> The application is provided ‚ÄúAS IS‚Äù, without warranties of any kind. Use at your own risk.</li>
          <li><strong>Limitation of Liability.</strong> To the maximum extent permitted by law, the author will not be liable for any indirect, incidental, special, consequential, or punitive damages, or any loss of data, even if advised of the possibility.</li>
          <li><strong>Support.</strong> Support is provided on a best‚Äëeffort basis and may be discontinued at any time.</li>
          <li><strong>Termination.</strong> This license terminates if you breach this EULA. Upon termination, stop using the app and delete any related data as required.</li>
          <li><strong>Changes.</strong> The EULA may be updated. Continued use after changes constitutes acceptance of the revised terms.</li>
          <li><strong>Governing Law.</strong> This EULA is governed by the laws applicable in your jurisdiction unless otherwise agreed in writing.</li>
        </ol>
          <p style="font-size:.9rem;color:#555">For queries email: <a href="mailto:esv.tnt010@gmail.com?subject=ClassTapMark">esv.tnt010@gmail.com</a></p>
        </div>
      </div>

      <div style="display:flex; gap:.6rem; justify-content:flex-end; margin-top: .75rem;">
        <button class="edit" id="helpPrintBtn" title="Print or Save as PDF">Print</button>
        <button class="primary" id="helpCloseBtn2">Close</button>
      </div>
    </div>
  </div>

  <!-- ============================ INLINE SCRIPTS ============================ -->
  <script>
  /* =========================================================================
     SECTION 0. Utilities & Global State
  ========================================================================= */
  let currentClassId = null;
  let currentStudents = [];
  let currentAttendance = {};
  let currentStudentIndex = 0;

  // Edit state for Students
  let editingStudentIndex = -1;
  let editingStudentId = null;

  // Export modal
  let selectedDates = [];

  function updateDebug(msg){
    const d = document.getElementById('debugInfo');
    d.innerHTML = `<div>${new Date().toLocaleTimeString()}: ${msg}</div>` + d.innerHTML;
    d.scrollTop = 0;
  }
  function generateId(){ return 'cls' + Date.now() + Math.random().toString(36).slice(2,10); }
  function todayStr(){ const d=new Date(); return d.toISOString().slice(0,10); }
  function setTodayDate(){
    const dp = document.getElementById('datePicker');
    const now = new Date();
    dp.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
  }
  function getSelectedSex(){
    const el = document.querySelector('input[name="studentSex"]:checked');
    return el ? el.value : '';
  }

  // Robust date parsing for import
  function parseDateFromCell(raw){
    if (raw == null || raw === '') return null;
    const s = String(raw).trim();
    if (!isNaN(s) && s !== '') { // Excel serial
      const serial = Number(s);
      if (serial > 0 && isFinite(serial)){
        const excelEpoch = Date.UTC(1899,11,30);
        return new Date(excelEpoch + serial*86400000).toISOString().slice(0,10);
      }
    }
    const d = new Date(s);
    return isNaN(d.getTime()) ? null : d.toISOString().slice(0,10);
  }

  /* =========================================================================
     SECTION 1. Classes
  ========================================================================= */
  function getAllClasses(){
    try{ const a = JSON.parse(localStorage.getItem('attendanceclasses')) || []; return Array.isArray(a) ? a : []; }catch{ return []; }
  }
  function saveAllClasses(arr){ localStorage.setItem('attendanceclasses', JSON.stringify(arr)); }
  function getStudentCount(classId){
    try{ const s = JSON.parse(localStorage.getItem(`students-${classId}`) || '[]'); return Array.isArray(s) ? s.length : 0; }catch{return 0;}
  }
  function populateClassDropdown(){
    const sel = document.getElementById('classDropdown');
    const classes = getAllClasses();
    sel.innerHTML = '<option value="">Select Class</option>';
    classes.forEach(c=>{
      const o = document.createElement('option');
      o.value = c.id; o.textContent = `${c.name} (${getStudentCount(c.id)})`;
      sel.appendChild(o);
    });
    updateClassButtons();
  }
  function updateClassButtons(){
    const id = document.getElementById('classDropdown').value;
    document.getElementById('btnEditClass').disabled   = !id;
    document.getElementById('btnDeleteClass').disabled = !id;
    const imp = document.querySelector('button[onclick="importCSV()"]');
    if (imp) imp.disabled = !id;
  }
  function addClass(){
    const name = document.getElementById('className').value.trim();
    if(!name){ alert('Enter class name!'); return; }
    const classes = getAllClasses();
    const existing = classes.find(c=>c.name.toLowerCase()===name.toLowerCase());
    if (existing){ alert('Class already exists.'); return; }
    const id = generateId();
    classes.push({ id, name, created:new Date().toISOString() });
    saveAllClasses(classes);
    document.getElementById('className').value = '';
    populateClassDropdown();
    document.getElementById('classDropdown').value = id;
    selectClass(id);
  }
  function editClass(){
    const id = document.getElementById('classDropdown').value;
    if(!id){ alert('Select class to edit'); return; }
    const cls = getAllClasses().find(x=>x.id===id);
    if(!cls) return;
    const newName = prompt('Edit class name:', cls.name);
    if (newName && newName.trim()){
      const classes = getAllClasses();
      const i = classes.findIndex(c=>c.id===id);
      classes[i].name = newName.trim();
      saveAllClasses(classes);
      populateClassDropdown();
      document.getElementById('classDropdown').value = id;
      selectClass(id);
    }
  }
  function deleteSelectedClass(){
    const id = document.getElementById('classDropdown').value;
    if(!id) return;
    if(!confirm('Delete class and ALL related data?')) return;
    for(const k of Object.keys(localStorage)){
      if (k === `students-${id}`) localStorage.removeItem(k);
      if (k.startsWith('attendance-') && k.endsWith(`-${id}`)) localStorage.removeItem(k);
    }
    const classes = getAllClasses().filter(c=>c.id!==id);
    if (classes.length) saveAllClasses(classes); else localStorage.removeItem('attendanceclasses');

    if (currentClassId === id){
      currentClassId = null;
      document.getElementById('classContent').classList.add('disabled');
      document.querySelector('#studentTable tbody').innerHTML = '';
      document.querySelector('#attendanceTable tbody').innerHTML = '';
      document.getElementById('statusTableBody').innerHTML = '';
      document.getElementById('currentStudent').textContent = 'Select a Class to begin...';
    }
    populateClassDropdown();
    updateClassButtons();
    cancelEdit();
    updateDebug('Class deleted and all related data removed.');
  }
  function selectClassFromDropdownWithCreate(){
    let id = document.getElementById('classDropdown').value;
    if(!id){
      const name = document.getElementById('className').value.trim();
      if(!name){ alert('Enter class name first, then select or create!'); return; }
      id = generateId();
      const classes = getAllClasses();
      classes.push({id,name,created:new Date().toISOString()});
      saveAllClasses(classes);
      populateClassDropdown();
      document.getElementById('classDropdown').value = id;
    }
    selectClass(id);
  }
  function selectClass(id){
    if(!id) return;
    currentClassId = id;
    const cls = getAllClasses().find(c=>c.id===id);
    if(!cls){ currentClassId=null; document.getElementById('classContent').classList.add('disabled'); return; }
    document.getElementById('classHeader').textContent = cls.name;
    document.getElementById('attendanceClassHeader').textContent = cls.name;
    document.getElementById('classContent').classList.remove('disabled');
    loadClassStudents();
    currentStudentIndex = 0;
    setTodayDate();
    document.getElementById('datePicker').dispatchEvent(new Event('change',{bubbles:true}));
    updateCurrentStudent();
    populateClassDropdown();
    updateStatusSummary();
    updateClassButtons();
    cancelEdit();
  }

  /* =========================================================================
     SECTION 2. Students
  ========================================================================= */
  function sortStudentsBySex(students){
    return students.sort((a,b)=>{
      if (a.sex==='Male' && b.sex!=='Male') return -1;
      if (b.sex==='Male' && a.sex!=='Male') return 1;
      return a.name.localeCompare(b.name);
    });
  }
  function loadClassStudents(){
    if(!currentClassId) return;
    const list = JSON.parse(localStorage.getItem(`students-${currentClassId}`) || '[]');
    currentStudents = sortStudentsBySex(Array.isArray(list)?list:[]);
    const tbody = document.querySelector('#studentTable tbody');
    let html = '';

    const males = currentStudents.filter(s=>s.sex==='Male');
    const females = currentStudents.filter(s=>s.sex==='Female');

    males.forEach((s,i)=>{
      const idx = currentStudents.findIndex(u=>u.id===s.id);
      html += `<tr>
        <td style="font-weight:600;color:#667eea;width:40px">${i+1}</td>
        <td>${s.name}</td>
        <td>${s.sex}</td>
        <td>${new Date(s.added).toISOString().slice(0,10)}</td>
        <td>
          <button class="edit" onclick="editStudent(${idx})" title="Edit">‚úèÔ∏è</button>
          <button class="danger" onclick="deleteStudent(${idx})" title="Delete">üóëÔ∏è</button>
        </td>
      </tr>`;
    });
    let fi=1;
    females.forEach(s=>{
      const idx = currentStudents.findIndex(u=>u.id===s.id);
      html += `<tr>
        <td style="font-weight:600;color:#667eea;width:40px">${fi}</td>
        <td>${s.name}</td>
        <td>${s.sex}</td>
        <td>${new Date(s.added).toISOString().slice(0,10)}</td>
        <td>
          <button class="edit" onclick="editStudent(${idx})" title="Edit">‚úèÔ∏è</button>
          <button class="danger" onclick="deleteStudent(${idx})" title="Delete">üóëÔ∏è</button>
        </td>
      </tr>`;
      fi++;
    });
    tbody.innerHTML = html;

    loadAttendance();
  }

  function addStudent(){
    if(!currentClassId){ alert('Select class first!'); return; }
    const nameEl = document.getElementById('studentName');
    const name = (nameEl.value || '').trim();
    const sex = getSelectedSex();
    if(!name || !sex){ alert('Name and sex required!'); return; }

    const dup = currentStudents.some((s,i)=> s.name.toLowerCase()===name.toLowerCase() && s.sex===sex && i!==editingStudentIndex);
    if (dup){ alert(`Duplicate name "${name}" (${sex}) already exists!`); return; }

    let students = currentStudents.slice();
    if (editingStudentIndex > -1 && currentStudents[editingStudentIndex]){
      const original = currentStudents[editingStudentIndex];
      students[editingStudentIndex] = { id: original.id, name, sex, added: original.added };
    }else{
      students.push({ id: generateId(), name, sex, added: new Date().toISOString() });
    }

    students = sortStudentsBySex(students);
    localStorage.setItem(`students-${currentClassId}`, JSON.stringify(students));
    loadClassStudents();

    cancelEdit();
    updateDebug('Student saved.');
  }

  function editStudent(index){
    const s = currentStudents[index];
    if(!s) return;
    editingStudentIndex = index;
    editingStudentId = s.id;
    document.getElementById('studentName').value = s.name;
    document.getElementById('sexMale').checked = (s.sex === 'Male');
    document.getElementById('sexFemale').checked = (s.sex === 'Female');

    const exportBtn = document.getElementById('btnExportStudent');
    exportBtn.disabled = false;
    exportBtn.textContent = `Export (${s.name})`;

    document.getElementById('btnCancelEdit').disabled = false;
  }

  function cancelEdit(){
    editingStudentIndex = -1;
    editingStudentId = null;
    const nameEl = document.getElementById('studentName');
    if (nameEl){ nameEl.value = ''; }
    document.getElementById('sexMale').checked = true;

    const exportBtn = document.getElementById('btnExportStudent');
    if (exportBtn){ exportBtn.disabled = true; exportBtn.textContent = 'Export Student'; }
    const cancelBtn = document.getElementById('btnCancelEdit');
    if (cancelBtn){ cancelBtn.disabled = true; }
  }

  function deleteStudent(index){
    if(!currentClassId) { alert('Select a class first.'); return; }
    const s = currentStudents[index];
    if(!s) return;
    if(!confirm(`Delete this student and ALL their attendance?\n\n${s.name} (${s.sex})`)) return;

    const students = currentStudents.slice();
    const sid = s.id;
    students.splice(index,1);
    localStorage.setItem(`students-${currentClassId}`, JSON.stringify(students));

    for (const k of Object.keys(localStorage)){
      if (k.startsWith('attendance-') && k.endsWith(`-${currentClassId}`)){
        try{
          const att = JSON.parse(localStorage.getItem(k) || '{}');
          if (sid in att){
            delete att[sid];
            if (Object.keys(att).length === 0) localStorage.removeItem(k);
            else localStorage.setItem(k, JSON.stringify(att));
          }
        }catch{}
      }
    }
    loadClassStudents();
    if (editingStudentId === sid) cancelEdit();
    updateDebug(`Deleted ${s.name} and removed all their attendance.`);
  }

  /* =========================================================================
     SECTION 3. Attendance
  ========================================================================= */
  function loadAttendance(){
    const date = document.getElementById('datePicker').value;
    if(!date || !currentClassId) return;
    const key = `attendance-${date}-${currentClassId}`;
    currentAttendance = JSON.parse(localStorage.getItem(key) || '{}');
    updateAttendanceDisplay();
    updateStatusSummary();
    updateCurrentStudent();
  }

  function markAttendance(status){
    const date = document.getElementById('datePicker').value;
    if(!date || !currentClassId) return;
    const student = currentStudents[currentStudentIndex];
    if(!student?.id){ alert('No student selected!'); return; }
    const key = `attendance-${date}-${currentClassId}`;
    const att = JSON.parse(localStorage.getItem(key) || '{}');
    att[student.id] = { status, timestamp:new Date().toISOString() };
    localStorage.setItem(key, JSON.stringify(att));
    document.querySelectorAll('.status-btn').forEach(b=>b.classList.remove('present','absent','tardy','cutting','excuse','pending','active'));
    if (window.event) window.event.target.classList.add(status,'active');
    loadAttendance();
  }

  function updateAttendanceDisplay(){
    const date = document.getElementById('datePicker').value;
    const tbody = document.querySelector('#attendanceTable tbody');
    if(!date || !currentClassId || !currentStudents.length){
      tbody.innerHTML = '<tr><td colspan="5">Select class and date</td></tr>'; return;
    }
    const males = currentStudents.filter(s=>s.sex==='Male');
    const females = currentStudents.filter(s=>s.sex==='Female');
    const color = s=>({present:'#28a745',absent:'#dc3545',tardy:'#ffc107',cutting:'#fd7e14',excuse:'#17a2b8',pending:'#ff9500'})[s] || '#ff9500';

    let html = '';
    males.forEach((st,i)=>{
      const rec = currentAttendance[st.id];
      const stt = (rec?rec.status:'pending').toLowerCase();
      html += `<tr>
        <td style="font-weight:600;color:#667eea;width:40px">${i+1}</td>
        <td>${st.name}</td><td>${st.sex}</td>
        <td style="font-weight:600;color:${color(stt)}">${stt.toUpperCase()}</td>
        <td>${date}</td>
      </tr>`;
    });
    let fi=1;
    females.forEach(st=>{
      const rec = currentAttendance[st.id];
      const stt = (rec?rec.status:'pending').toLowerCase();
      html += `<tr>
        <td style="font-weight:600;color:#667eea;width:40px">${fi}</td>
        <td>${st.name}</td><td>${st.sex}</td>
        <td style="font-weight:600;color:${color(stt)}">${stt.toUpperCase()}</td>
        <td>${date}</td>
      </tr>`;
      fi++;
    });
    tbody.innerHTML = html;
  }

  function updateStatusSummary(){
    const statuses = ['present','absent','tardy','cutting','excuse','pending'];
    const male={}, female={}, total={};
    statuses.forEach(s=>{ male[s]=0; female[s]=0; total[s]=0; });
    currentStudents.forEach(st=>{
      const rec = currentAttendance[st.id];
      const s = (rec?rec.status:'pending');
      if (st.sex==='Male') male[s]++; else female[s]++;
      total[s]++;
    });
    const males = currentStudents.filter(s=>s.sex==='Male').length || 0;
    const females = currentStudents.filter(s=>s.sex==='Female').length || 0;
    const t = currentStudents.length || 0;
    const body = document.getElementById('statusTableBody');
    body.innerHTML = `
      <tr><td>Male: ${males}</td>${statuses.map(s=>`<td>${male[s]}</td>`).join('')}</tr>
      <tr><td>Female: ${females}</td>${statuses.map(s=>`<td>${female[s]}</td>`).join('')}</tr>
      <tr style="font-weight:bold;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff">
        <td>Total: ${t}</td>${statuses.map(s=>`<td>${total[s]}</td>`).join('')}
      </tr>`;
  }

  function navigateStudent(dir){
    document.querySelectorAll('.status-btn').forEach(btn=>btn.classList.remove('present','absent','tardy','cutting','excuse','pending','active'));
    const len = currentStudents.length; if(!len) return;
    if (dir==='first') currentStudentIndex=0;
    else if (dir==='prev' && currentStudentIndex>0) currentStudentIndex--;
    else if (dir==='next' && currentStudentIndex<len-1) currentStudentIndex++;
    else if (dir==='last') currentStudentIndex=len-1;
    updateCurrentStudent();
  }

  function updateCurrentStudent(){
    if(!currentStudents || currentStudentIndex>=currentStudents.length){
      document.getElementById('currentStudent').textContent='No students'; return;
    }
    const s = currentStudents[currentStudentIndex];
    const rec = currentAttendance[s.id];
    const status = (rec?rec.status:'PENDING').toLowerCase();
    const color = {present:'#28a745',absent:'#dc3545',tardy:'#e0a800',cutting:'#fd7e14',excuse:'#17a2b8',pending:'#ff9500'}[status] || '#ff9500';
    document.getElementById('currentStudent').innerHTML =
      `Student ${currentStudentIndex+1} of ${currentStudents.length}<br><strong>${s.name}</strong> (${s.sex})<br>` +
      `<span style="color:${color};font-weight:600;font-size:1.05rem">${status.toUpperCase()}</span>`;
  }

  /* =========================================================================
     SECTION 4. Export (Class & Student)
  ========================================================================= */
  function openExportModal(){
    if(!currentClassId){ alert('Select a class first!'); return; }
    selectedDates = [];
    const ds = document.getElementById('dateSelection');
    const today = new Date();
    const tStr = todayStr();
    let html = '';

    // FUTURE (top)
    html += '<div class="date-container" id="futureDates">';
    for (let i=364;i>=1;i--){
      const d = new Date(today); d.setDate(today.getDate()+i);
      const s = d.toISOString().split('T')[0];
      const l = d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'});
      html += `<label title="${s}"><input type="checkbox" value="${s}" onchange="toggleDate('${s}')"> ${l}</label>`;
    }
    html += '</div>';

    // PRESENT (center) ‚Äì default checked
    const lToday = today.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'});
    html += `<label class="current-date-center" title="${tStr}">
      <input type="checkbox" value="${tStr}" onchange="toggleDate('${tStr}')" checked> Present Date ${lToday}
    </label>`;

    // PAST (bottom)
    html += '<div class="date-container" id="pastDates">';
    for (let i=1;i<=365;i++){
      const d = new Date(today); d.setDate(today.getDate()-i);
      const s = d.toISOString().split('T')[0];
      const l = d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'});
      html += `<label title="${s}"><input type="checkbox" value="${s}" onchange="toggleDate('${s}')"> ${l}</label>`;
    }
    html += '</div>';

    ds.innerHTML = html;
    selectedDates = [tStr];
    document.getElementById('exportModal').style.display='block';

    // Auto-scroll FUTURE container to bottom so Present is in view
    setTimeout(()=>{
      const futureEl = document.getElementById('futureDates');
      if (futureEl) futureEl.scrollTop = futureEl.scrollHeight;
    }, 0);
  }
  function toggleDate(s){
    const i = selectedDates.indexOf(s);
    if (i>-1) selectedDates.splice(i,1); else selectedDates.push(s);
  }
  function closeExportModal(){ document.getElementById('exportModal').style.display='none'; }
  function confirmExport(){
    if(selectedDates.length===0){ alert('Select at least one date!'); return; }
    closeExportModal();

    const classes = getAllClasses();
    const cls = classes.find(c=>c.id===currentClassId);
    const className = cls?cls.name:'unknown';
    const safeClass = className.replace(/[^a-zA-Z0-9_\-]/g,'_');

    const rows = ['"Class","Student","Sex","Status","Date"'];
    const dates = [...selectedDates].sort((a,b)=>a.localeCompare(b));
    dates.forEach(dateStr=>{
      const key = `attendance-${dateStr}-${currentClassId}`;
      const data = JSON.parse(localStorage.getItem(key) || '{}');
      currentStudents.forEach(st=>{
        const status = (data[st.id]?.status || 'PENDING').toUpperCase();
        const fields = [
          className.replace(/"/g,'""'),
          st.name.replace(/"/g,'""'),
          st.sex.replace(/"/g,'""'),
          status.replace(/"/g,'""'),
          dateStr.replace(/"/g,'""')
        ];
        rows.push(fields.map(f=>`"${f}"`).join(','));
      });
    });
    const csv = rows.join('\r\n');
    const filename = (dates.length===1)
      ? `${dates[0]}_${safeClass}_attendance.csv`
      : `${dates[0]}_to_${dates[dates.length-1]}_${safeClass}_attendance.csv`;
    downloadFile(csv, filename, 'text/csv');
    updateDebug('Class CSV exported.');
  }
  function exportCSV(){ // per-student (exclude PENDING)
    if(!currentClassId){ alert('Select a class first!'); return; }
    if (editingStudentIndex < 0 || !currentStudents[editingStudentIndex]){ alert('Click ‚úèÔ∏è Edit on a student to enable Export.'); return; }
    const s = currentStudents[editingStudentIndex];

    const classes = getAllClasses();
    const cls = classes.find(c=>c.id===currentClassId);
    const className = cls?cls.name:'Unknown Class';

    const allDates = [];
    for (const k of Object.keys(localStorage)){
      if (k.startsWith('attendance-') && k.endsWith(`-${currentClassId}`)){
        const parts = k.split('-');
        if (parts.length >= 5){
          const ds = parts.slice(1,4).join('-');
          if (/^\d{4}-\d{2}-\d{2}$/.test(ds)) allDates.push(ds);
        }
      }
    }
    allDates.sort((a,b)=>a.localeCompare(b));

    const rows = ['"Class","Student","Sex","Status","Date"'];
    let count = 0;
    allDates.forEach(dateStr=>{
      const key = `attendance-${dateStr}-${currentClassId}`;
      const att = JSON.parse(localStorage.getItem(key) || '{}');
      const raw = (att[s.id]?.status || 'PENDING').toUpperCase();
      if (raw !== 'PENDING'){
        count++;
        const fields = [
          className.replace(/"/g,'""'),
          s.name.replace(/"/g,'""'),
          s.sex.replace(/"/g,'""'),
          raw.replace(/"/g,'""'),
          dateStr.replace(/"/g,'""')
        ];
        rows.push(fields.map(f=>`"${f}"`).join(','));
      }
    });
    if (count === 0){ alert(`No non-PENDING attendance records found for "${s.name}".`); return; }
    const safeClass = className.replace(/[^a-zA-Z0-9_\-]/g,'_');
    const safeName  = s.name.replace(/[^a-zA-Z0-9_\-]/g,'_');
    const csv = rows.join('\r\n');
    downloadFile(csv, `${safeClass}_${safeName}_attendance_no_pending.csv`, 'text/csv');
    updateDebug(`Exported ${count} row(s) for "${s.name}" (excluding PENDING).`);
  }
  function downloadFile(content, filename, mimeType){
    try{
      const blob = new Blob([content], {type:mimeType || 'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
    }catch(e){ alert('Download failed: '+e.message); }
  }

  /* =========================================================================
     SECTION 5. Import (CSV/XLSX)
  ========================================================================= */
  function importCSV(){
    const targetClassId = document.getElementById('classDropdown').value;
    if(!targetClassId){ alert('Please select a class from the dropdown first.'); return; }
    const input = document.createElement('input');
    input.type = 'file'; input.accept = '.csv,.xlsx,.xls';
    input.onchange = (e)=>handleCSVFile(e, targetClassId);
    input.click();
  }
  function handleCSVFile(e, targetClassId){
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (ev)=>{
      try{
        const data = new Uint8Array(ev.target.result);
        const wb = XLSX.read(data, {type:'array', raw:true, cellDates:true});
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, {header:1, raw:true});
        if(!Array.isArray(rows) || rows.length<=1){ alert('No rows found.'); return; }
        rows.shift();

        const toAdd = [];
        const attendanceRows = [];
        rows.forEach(r=>{
          const student  = (r[1] ?? '').toString().trim();
          const sex      = (r[2] ?? '').toString().trim();
          let   status   = (r[3] ?? 'pending').toString().trim().toLowerCase();
          let   dateStr  = parseDateFromCell(r[4]);
          if (!student || !['Male','Female'].includes(sex)) return;
          if (!dateStr) dateStr = todayStr();
          if (!['present','absent','tardy','cutting','excuse','pending'].includes(status)) status = 'pending';
          toAdd.push({student, sex});
          attendanceRows.push({student, sex, status, dateStr});
        });

        let list = JSON.parse(localStorage.getItem(`students-${targetClassId}`) || '[]');
        const seen = new Set(list.map(s=>`${s.name.toLowerCase()}|${s.sex}`));
        toAdd.forEach(it=>{
          const key = `${it.student.toLowerCase()}|${it.sex}`;
          if (!seen.has(key)){
            seen.add(key);
            list.push({ id: generateId(), name: it.student, sex: it.sex, added: new Date().toISOString() });
          }
        });
        list = sortStudentsBySex(list);
        localStorage.setItem(`students-${targetClassId}`, JSON.stringify(list));

        const idMap = new Map(list.map(s=>[`${s.name.toLowerCase()}|${s.sex}`, s.id]));

        attendanceRows.forEach(it=>{
          const sid = idMap.get(`${it.student.toLowerCase()}|${it.sex}`);
          if (!sid) return;
          const k = `attendance-${it.dateStr}-${targetClassId}`;
          const att = JSON.parse(localStorage.getItem(k) || '{}');
          att[sid] = { status: it.status, timestamp: new Date().toISOString() };
          localStorage.setItem(k, JSON.stringify(att));
        });

        alert('Success! Import complete.');
        if (currentClassId !== targetClassId) selectClass(targetClassId); else loadClassStudents();
        const dp = document.getElementById('datePicker');
        dp.value = attendanceRows[0]?.dateStr || todayStr();
        dp.dispatchEvent(new Event('change', {bubbles:true}));
        updateDebug('Import done.');
      }catch(err){
        alert('Import failed: '+err.message);
        updateDebug('Import error: '+err.message);
      }
    };
    reader.readAsArrayBuffer(file);
  }

  /* =========================================================================
     SECTION 6. License (Lock/Unlock)
  ========================================================================= */
  window.CTM_PUBLIC_KEY_HEX = '045d419f4adf281c3b46a8ee14dfcd85a46eda6f6603ec7067d59ee234d5cd1999c6992fd97cedee9ad1da628f04e8733b0669e3cd81845e43b6c5243b9a90294f';
  const CTM = (() => {
    const PRODUCT_ID = 'classtapmark';

    function hexToBytes(hex){
      const h = String(hex ?? '').trim();
      if (!/^([0-9a-fA-F]{2})+$/.test(h)) throw new Error('Signature must be hex (pairs of 0-9a-f)');
      const out = new Uint8Array(h.length/2);
      for (let i=0;i<out.length;i++) out[i] = parseInt(h.substr(i*2,2),16);
      return out;
    }
    async function importPublicKeyFromHex(rawHex){
      const bytes = hexToBytes(rawHex);
      if (bytes.length!==65 || bytes[0]!==0x04) throw new Error('Public key must be 65-byte uncompressed');
      return await crypto.subtle.importKey('raw', bytes, {name:'ECDSA', namedCurve:'P-256'}, false, ['verify']);
    }
    const normEmail = e => String(e??'').trim().toLowerCase();
    const licenseCore = lic => String(lic??'').trim().replace(/^PRO-/i,'').replace(/^CTM-/i,'');
    const buildMessage = (email,license) => new TextEncoder().encode(`${normEmail(email)}:${licenseCore(license)}:${PRODUCT_ID}`);
    async function verify(sigHex,email,license){
      const pub = await importPublicKeyFromHex(window.CTM_PUBLIC_KEY_HEX ?? '');
      const data = buildMessage(email, license);
      const sig = hexToBytes(sigHex);
      return await crypto.subtle.verify({name:'ECDSA',hash:'SHA-256'}, pub, sig, data);
    }

    const KEY_EMAIL='ctm_input_email', KEY_LIC='ctm_input_license', KEY_SIG='ctm_input_signature';
    function saveInputs(){
      localStorage.setItem(KEY_EMAIL, document.getElementById('proEmail')?.value ?? '');
      localStorage.setItem(KEY_LIC, document.getElementById('proLicense')?.value ?? '');
      localStorage.setItem(KEY_SIG, document.getElementById('proSignature')?.value ?? '');
    }
    function loadInputs(){
      const e = localStorage.getItem(KEY_EMAIL), l = localStorage.getItem(KEY_LIC), s = localStorage.getItem(KEY_SIG);
      if (e!=null) document.getElementById('proEmail').value = e;
      if (l!=null) document.getElementById('proLicense').value = l;
      if (s!=null) document.getElementById('proSignature').value = s;
    }

function updateAccessUIForLockState(isLocked){
  const email = document.getElementById('proEmail');
  const lic   = document.getElementById('proLicense');
  const sig   = document.getElementById('proSignature');
  const btn   = document.getElementById('proValidate');

  // Keep inputs ALWAYS visible; only toggle disabled/readOnly states.
  [email, lic, sig].forEach(el => {
    if (!el) return;
    el.style.display = '';                 // never hide
    el.removeAttribute('aria-hidden');     // keep exposed to AT
    el.toggleAttribute('disabled', !isLocked); // unlocked -> disabled
    el.readOnly = !isLocked;               // UX hint on some UAs
    // Optional: cursor hint when disabled
    el.style.cursor = !isLocked ? 'not-allowed' : '';
  });

  if (btn){
    btn.textContent = isLocked ? 'Unlock' : 'Lock';
    btn.setAttribute('title', btn.textContent);
  }
}

    function lock(){
      document.body.classList.add('locked');
      updateAccessUIForLockState(true);
      localStorage.removeItem('ctm_verified');
      localStorage.removeItem('ctm_license_record');
      saveInputs();
      const status = document.getElementById('proStatus');
      if (status){ status.textContent = 'üîí Locked'; status.className=''; }
    }
    function unlock(){
      document.body.classList.remove('locked');
      updateAccessUIForLockState(false);
    }
    async function validate(){
      const email = document.getElementById('proEmail').value;
      const license = document.getElementById('proLicense').value;
      const signature = document.getElementById('proSignature').value;
      const status = document.getElementById('proStatus');
      status.className=''; status.textContent = 'Validating‚Ä¶';
      try{
        if (!window.CTM_PUBLIC_KEY_HEX || window.CTM_PUBLIC_KEY_HEX.length < 100) throw new Error('Public key not set.');
        if (!email || !license || !signature) throw new Error('Please fill Email, License, and Signature.');
        const ok = await verify(signature, email, license);
        if (!ok) throw new Error('Invalid email/license/signature.');
        saveInputs();
        localStorage.setItem('ctm_license_record', JSON.stringify({email: normEmail(email), license, signature}));
        localStorage.setItem('ctm_verified', '1');
        unlock();
        status.textContent = '‚úÖ Unlocked ‚Äî license verified';
        status.classList.add('ok');
      }catch(err){
        lock();
        status.textContent = err.message;
        status.classList.add('err');
      }
    }
    async function boot(){
      loadInputs();
      lock();
      const saved = localStorage.getItem('ctm_license_record');
      if (saved){
        try{
          const {email,license,signature} = JSON.parse(saved);
          if (await verify(signature,email,license)){
            unlock();
            const status = document.getElementById('proStatus');
            if (status){ status.textContent = 'üîì Unlocked (auto)'; status.classList.add('ok'); }
          }
        }catch{}
      }
    }
    document.addEventListener('DOMContentLoaded', ()=>{
      ['proEmail','proLicense','proSignature'].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', saveInputs);
      });
      const btn = document.getElementById('proValidate');
      if (btn) btn.addEventListener('click', ()=>{ 
        if (document.body.classList.contains('locked')) validate(); else lock();
      });
      const clr = document.getElementById('proClear');
      if (clr) clr.addEventListener('click', ()=>{
        try{
          localStorage.removeItem('ctm_verified');
          localStorage.removeItem('ctm_license_record');
          localStorage.removeItem('ctm_input_email');
          localStorage.removeItem('ctm_input_license');
          localStorage.removeItem('ctm_input_signature');
          document.getElementById('proEmail').value='';
          document.getElementById('proLicense').value='';
          document.getElementById('proSignature').value='';
          lock();
          const status = document.getElementById('proStatus');
          if (status){ status.textContent='üîí License cleared'; status.className='ok'; }
        }catch(e){ alert('Clear License failed: '+e.message); }
      });
      boot();
    });
    return { validate, lock, unlock };
  })();

  /* =========================================================================
     SECTION 7. App Init / Events
  ========================================================================= */
  document.addEventListener('DOMContentLoaded', ()=>{
    populateClassDropdown();
    document.getElementById('sexMale').checked = true;
    setTodayDate();
    setTimeout(()=>document.getElementById('datePicker').dispatchEvent(new Event('change',{bubbles:true})), 50);

    document.getElementById('classDropdown').addEventListener('change', updateClassButtons);
    document.getElementById('datePicker').addEventListener('change', ()=>{ if(currentClassId) loadAttendance(); });

    updateDebug('All features active - Ready!');
  });
  function clearDebug(){ document.getElementById('debugInfo').innerHTML='Task log cleared'; }

  /* =========================================================================
     SECTION 8. PWA Service Worker
  ========================================================================= */
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('/ClassTapMark/sw.js')
        .then(()=>console.log('SW registered!'))
        .catch(err=>console.log('SW registration failed:', err));
    });
  }

  /* =========================================================================
     SECTION 9. Help/EULA modal (FAB always accessible)
  ========================================================================= */
  (function(){
    function openHelp(){
      const m = document.getElementById('helpModal');
      if (!m) return;
      m.style.display = 'block';
      m.setAttribute('aria-hidden','false');
    }
    function closeHelp(){
      const m = document.getElementById('helpModal');
      if (!m) return;
      m.style.display = 'none';
      m.setAttribute('aria-hidden','true');
    }
    document.addEventListener('DOMContentLoaded', ()=>{
      const fabHelp   = document.getElementById('fabHelp');
      const helpModal = document.getElementById('helpModal');
      const btnX      = document.getElementById('helpCloseBtn');
      const btnClose  = document.getElementById('helpCloseBtn2');
      const btnPrint  = document.getElementById('helpPrintBtn');
      const eulaDate  = document.getElementById('eulaDate');

      if (eulaDate){
        const d = new Date();
        eulaDate.textContent = d.toLocaleDateString(undefined, {year:'numeric', month:'long', day:'numeric'});
      }
      if (fabHelp)  fabHelp.addEventListener('click', openHelp);
      if (btnX)     btnX.addEventListener('click', closeHelp);
      if (btnClose) btnClose.addEventListener('click', closeHelp);
      if (btnPrint) btnPrint.addEventListener('click', ()=>window.print());

      if (helpModal){ helpModal.addEventListener('click', (e)=>{ if (e.target === helpModal) closeHelp(); }); }
      document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && helpModal && helpModal.style.display === 'block') closeHelp(); });
    });
  })();
  </script>
</body>
</html>
